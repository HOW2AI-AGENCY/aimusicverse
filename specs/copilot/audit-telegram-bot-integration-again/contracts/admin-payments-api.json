{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Admin Payments API Contract",
  "description": "API contract for admin payment monitoring and analytics",
  "version": "1.0.0",
  "basePath": "/functions/v1",
  "paths": {
    "/stars-admin-stats": {
      "get": {
        "summary": "Get payment statistics",
        "description": "Retrieve payment analytics for admin dashboard",
        "operationId": "getPaymentStats",
        "tags": ["Admin"],
        "security": [
          {
            "admin_auth": []
          }
        ],
        "parameters": [
          {
            "name": "from",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "description": "Start date for statistics (default: 30 days ago)"
          },
          {
            "name": "to",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "description": "End date for statistics (default: now)"
          }
        ],
        "responses": {
          "200": {
            "description": "Statistics retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/PaymentStatsResponse"
                },
                "example": {
                  "success": true,
                  "period": {
                    "from": "2024-11-09T00:00:00.000Z",
                    "to": "2024-12-09T23:59:59.999Z"
                  },
                  "totalTransactions": 1523,
                  "totalRevenueStars": 762000,
                  "totalRevenueUSD": 7620.0,
                  "successRate": 98.5,
                  "topProducts": [
                    {
                      "productName": "100 Credits Package",
                      "sku": "credits_100",
                      "salesCount": 687,
                      "revenueStars": 343500
                    },
                    {
                      "productName": "Pro Subscription",
                      "sku": "sub_pro",
                      "salesCount": 342,
                      "revenueStars": 684000
                    }
                  ],
                  "activeSubscriptions": 428,
                  "failureReasons": [
                    {
                      "reason": "insufficient_funds",
                      "count": 12
                    },
                    {
                      "reason": "payment_declined",
                      "count": 8
                    }
                  ]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized (not admin)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/stars-admin-transactions": {
      "get": {
        "summary": "Get transaction list",
        "description": "Retrieve paginated list of Stars transactions",
        "operationId": "getTransactionList",
        "tags": ["Admin"],
        "security": [
          {
            "admin_auth": []
          }
        ],
        "parameters": [
          {
            "name": "page",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 1,
              "default": 1
            },
            "description": "Page number (1-indexed)"
          },
          {
            "name": "perPage",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "minimum": 10,
              "maximum": 100,
              "default": 50
            },
            "description": "Items per page"
          },
          {
            "name": "status",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["pending", "completed", "failed", "refunded"]
            },
            "description": "Filter by transaction status"
          },
          {
            "name": "productType",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["credits", "subscription"]
            },
            "description": "Filter by product type"
          },
          {
            "name": "userId",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "Filter by user ID"
          },
          {
            "name": "search",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            },
            "description": "Search by username or transaction ID"
          }
        ],
        "responses": {
          "200": {
            "description": "Transaction list retrieved",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TransactionListResponse"
                },
                "example": {
                  "success": true,
                  "transactions": [
                    {
                      "id": "123e4567-e89b-12d3-a456-426614174001",
                      "userId": "123e4567-e89b-12d3-a456-426614174000",
                      "username": "john_doe",
                      "productName": "100 Credits Package",
                      "productSku": "credits_100",
                      "amountStars": 500,
                      "amountUSD": 5.0,
                      "status": "completed",
                      "telegramChargeId": "tg_charge_1A2B3C4D5E6F",
                      "createdAt": "2024-12-09T10:30:00.000Z",
                      "completedAt": "2024-12-09T10:30:05.123Z"
                    }
                  ],
                  "pagination": {
                    "page": 1,
                    "perPage": 50,
                    "totalPages": 31,
                    "totalItems": 1523
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/stars-admin-refund": {
      "post": {
        "summary": "Refund payment",
        "description": "Refund Stars payment and deduct credits",
        "operationId": "refundPayment",
        "tags": ["Admin"],
        "security": [
          {
            "admin_auth": []
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RefundRequest"
              },
              "example": {
                "transactionId": "123e4567-e89b-12d3-a456-426614174001",
                "reason": "User requested refund within 24 hours"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Refund processed successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RefundResponse"
                },
                "example": {
                  "success": true,
                  "refundedAmount": 500,
                  "creditsDeducted": 100,
                  "telegramRefundId": "tg_refund_7G8H9I0J1K2L"
                }
              }
            }
          },
          "400": {
            "description": "Invalid refund request (already refunded, too late)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "success": false,
                  "error": {
                    "code": "REFUND_NOT_ALLOWED",
                    "message": "Refund period expired (>24 hours since purchase)"
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "PaymentStatsResponse": {
        "type": "object",
        "required": ["success", "period", "totalTransactions", "totalRevenueStars", "successRate"],
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "period": {
            "type": "object",
            "required": ["from", "to"],
            "properties": {
              "from": {
                "type": "string",
                "format": "date-time"
              },
              "to": {
                "type": "string",
                "format": "date-time"
              }
            }
          },
          "totalTransactions": {
            "type": "integer",
            "description": "Total number of transactions"
          },
          "totalRevenueStars": {
            "type": "integer",
            "description": "Total revenue in Stars"
          },
          "totalRevenueUSD": {
            "type": "number",
            "description": "Approximate USD revenue"
          },
          "successRate": {
            "type": "number",
            "minimum": 0,
            "maximum": 100,
            "description": "Percentage of successful payments"
          },
          "topProducts": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TopProduct"
            }
          },
          "activeSubscriptions": {
            "type": "integer",
            "description": "Number of active subscriptions"
          },
          "failureReasons": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/FailureReason"
            }
          }
        }
      },
      "TopProduct": {
        "type": "object",
        "required": ["productName", "sku", "salesCount", "revenueStars"],
        "properties": {
          "productName": {
            "type": "string"
          },
          "sku": {
            "type": "string"
          },
          "salesCount": {
            "type": "integer"
          },
          "revenueStars": {
            "type": "integer"
          }
        }
      },
      "FailureReason": {
        "type": "object",
        "required": ["reason", "count"],
        "properties": {
          "reason": {
            "type": "string",
            "enum": [
              "insufficient_funds",
              "payment_declined",
              "timeout",
              "cancelled",
              "validation_failed",
              "internal_error"
            ]
          },
          "count": {
            "type": "integer"
          }
        }
      },
      "TransactionListResponse": {
        "type": "object",
        "required": ["success", "transactions", "pagination"],
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "transactions": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/AdminTransaction"
            }
          },
          "pagination": {
            "$ref": "#/components/schemas/Pagination"
          }
        }
      },
      "AdminTransaction": {
        "type": "object",
        "required": [
          "id",
          "userId",
          "productName",
          "productSku",
          "amountStars",
          "status",
          "telegramChargeId",
          "createdAt"
        ],
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid"
          },
          "userId": {
            "type": "string",
            "format": "uuid"
          },
          "username": {
            "type": "string",
            "description": "Telegram username"
          },
          "productName": {
            "type": "string"
          },
          "productSku": {
            "type": "string"
          },
          "amountStars": {
            "type": "integer"
          },
          "amountUSD": {
            "type": "number"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "completed", "failed", "refunded"]
          },
          "telegramChargeId": {
            "type": "string"
          },
          "failureReason": {
            "type": "string",
            "description": "Reason if status = failed"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "completedAt": {
            "type": "string",
            "format": "date-time"
          },
          "refundedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "Pagination": {
        "type": "object",
        "required": ["page", "perPage", "totalPages", "totalItems"],
        "properties": {
          "page": {
            "type": "integer",
            "minimum": 1
          },
          "perPage": {
            "type": "integer",
            "minimum": 1
          },
          "totalPages": {
            "type": "integer",
            "minimum": 0
          },
          "totalItems": {
            "type": "integer",
            "minimum": 0
          }
        }
      },
      "RefundRequest": {
        "type": "object",
        "required": ["transactionId"],
        "properties": {
          "transactionId": {
            "type": "string",
            "format": "uuid",
            "description": "Stars transaction ID to refund"
          },
          "reason": {
            "type": "string",
            "description": "Reason for refund (for audit log)",
            "maxLength": 500
          }
        }
      },
      "RefundResponse": {
        "type": "object",
        "required": ["success", "refundedAmount"],
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "refundedAmount": {
            "type": "integer",
            "description": "Amount refunded in Stars"
          },
          "creditsDeducted": {
            "type": "integer",
            "description": "Credits deducted from user (if applicable)"
          },
          "telegramRefundId": {
            "type": "string",
            "description": "Telegram refund identifier"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "required": ["success", "error"],
        "properties": {
          "success": {
            "type": "boolean",
            "example": false
          },
          "error": {
            "type": "object",
            "required": ["code", "message"],
            "properties": {
              "code": {
                "type": "string",
                "enum": [
                  "UNAUTHORIZED",
                  "TRANSACTION_NOT_FOUND",
                  "REFUND_NOT_ALLOWED",
                  "INTERNAL_ERROR"
                ]
              },
              "message": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "securitySchemes": {
      "admin_auth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Admin user authentication (requires admin role)"
      }
    }
  },
  "tags": [
    {
      "name": "Admin",
      "description": "Admin-only payment monitoring and management"
    }
  ]
}
