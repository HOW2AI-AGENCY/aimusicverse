{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Telegram Payment Webhook Contracts",
  "description": "JSON schemas for Telegram Bot API payment webhook payloads",
  "definitions": {
    "PreCheckoutQuery": {
      "type": "object",
      "title": "Pre-Checkout Query",
      "description": "Telegram sends this before processing payment (validation step)",
      "required": ["id", "from", "currency", "total_amount", "invoice_payload"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique query identifier",
          "example": "1234567890123456"
        },
        "from": {
          "$ref": "#/definitions/User"
        },
        "currency": {
          "type": "string",
          "description": "Three-letter ISO 4217 currency code (XTR for Telegram Stars)",
          "enum": ["XTR"],
          "example": "XTR"
        },
        "total_amount": {
          "type": "integer",
          "description": "Total price in the smallest units of the currency (stars for XTR)",
          "minimum": 1,
          "example": 500
        },
        "invoice_payload": {
          "type": "string",
          "description": "Bot-specified invoice payload (JSON string)",
          "example": "{\"userId\":\"123e4567-e89b-12d3-a456-426614174000\",\"productId\":\"credits_100\",\"amount\":100}"
        },
        "shipping_option_id": {
          "type": "string",
          "description": "Optional. Identifier of the shipping option chosen by the user",
          "example": "standard_shipping"
        },
        "order_info": {
          "$ref": "#/definitions/OrderInfo"
        }
      },
      "example": {
        "id": "1234567890123456",
        "from": {
          "id": 123456789,
          "is_bot": false,
          "first_name": "John",
          "username": "john_doe"
        },
        "currency": "XTR",
        "total_amount": 500,
        "invoice_payload": "{\"userId\":\"123e4567-e89b-12d3-a456-426614174000\",\"productId\":\"credits_100\",\"amount\":100}"
      }
    },
    "SuccessfulPayment": {
      "type": "object",
      "title": "Successful Payment",
      "description": "Payment completed successfully (credit allocation step)",
      "required": [
        "currency",
        "total_amount",
        "invoice_payload",
        "telegram_payment_charge_id",
        "provider_payment_charge_id"
      ],
      "properties": {
        "currency": {
          "type": "string",
          "description": "Three-letter ISO 4217 currency code",
          "enum": ["XTR"],
          "example": "XTR"
        },
        "total_amount": {
          "type": "integer",
          "description": "Total price in stars",
          "minimum": 1,
          "example": 500
        },
        "invoice_payload": {
          "type": "string",
          "description": "Bot-specified invoice payload (JSON string)",
          "example": "{\"userId\":\"123e4567-e89b-12d3-a456-426614174000\",\"productId\":\"credits_100\",\"amount\":100}"
        },
        "shipping_option_id": {
          "type": "string",
          "description": "Optional. Identifier of the shipping option chosen by the user"
        },
        "order_info": {
          "$ref": "#/definitions/OrderInfo"
        },
        "telegram_payment_charge_id": {
          "type": "string",
          "description": "Telegram payment identifier (IDEMPOTENCY KEY)",
          "example": "tg_charge_1A2B3C4D5E6F"
        },
        "provider_payment_charge_id": {
          "type": "string",
          "description": "Provider payment identifier (empty for Stars)",
          "example": ""
        }
      },
      "example": {
        "currency": "XTR",
        "total_amount": 500,
        "invoice_payload": "{\"userId\":\"123e4567-e89b-12d3-a456-426614174000\",\"productId\":\"credits_100\",\"amount\":100}",
        "telegram_payment_charge_id": "tg_charge_1A2B3C4D5E6F",
        "provider_payment_charge_id": ""
      }
    },
    "User": {
      "type": "object",
      "required": ["id", "is_bot", "first_name"],
      "properties": {
        "id": {
          "type": "integer",
          "description": "Unique identifier for this user or bot",
          "example": 123456789
        },
        "is_bot": {
          "type": "boolean",
          "description": "True, if this user is a bot",
          "example": false
        },
        "first_name": {
          "type": "string",
          "description": "User's first name",
          "example": "John"
        },
        "last_name": {
          "type": "string",
          "description": "Optional. User's last name",
          "example": "Doe"
        },
        "username": {
          "type": "string",
          "description": "Optional. User's username",
          "example": "john_doe"
        },
        "language_code": {
          "type": "string",
          "description": "Optional. IETF language tag of the user's language",
          "example": "en"
        }
      }
    },
    "OrderInfo": {
      "type": "object",
      "description": "Information about an order (usually empty for Stars)",
      "properties": {
        "name": {
          "type": "string",
          "description": "Optional. User name"
        },
        "phone_number": {
          "type": "string",
          "description": "Optional. User's phone number"
        },
        "email": {
          "type": "string",
          "description": "Optional. User email"
        },
        "shipping_address": {
          "$ref": "#/definitions/ShippingAddress"
        }
      }
    },
    "ShippingAddress": {
      "type": "object",
      "required": ["country_code", "state", "city", "street_line1", "post_code"],
      "properties": {
        "country_code": {
          "type": "string",
          "description": "ISO 3166-1 alpha-2 country code"
        },
        "state": {
          "type": "string",
          "description": "State, if applicable"
        },
        "city": {
          "type": "string",
          "description": "City"
        },
        "street_line1": {
          "type": "string",
          "description": "First line for the address"
        },
        "street_line2": {
          "type": "string",
          "description": "Second line for the address"
        },
        "post_code": {
          "type": "string",
          "description": "Address post code"
        }
      }
    },
    "InvoicePayload": {
      "type": "object",
      "title": "Invoice Payload",
      "description": "Custom payload structure sent in invoice and returned in webhooks",
      "required": ["userId", "productId"],
      "properties": {
        "userId": {
          "type": "string",
          "format": "uuid",
          "description": "User ID making the purchase",
          "example": "123e4567-e89b-12d3-a456-426614174000"
        },
        "productId": {
          "type": "string",
          "description": "Product SKU (e.g., credits_100, sub_pro)",
          "pattern": "^(credits_\\d+|sub_[a-z]+)$",
          "example": "credits_100"
        },
        "metadata": {
          "type": "object",
          "description": "Optional metadata for tracking",
          "properties": {
            "source": {
              "type": "string",
              "enum": ["mini_app", "bot", "web"],
              "example": "mini_app"
            },
            "campaign": {
              "type": "string",
              "description": "Marketing campaign ID",
              "example": "black_friday_2025"
            }
          }
        }
      }
    }
  },
  "examples": {
    "PreCheckoutQueryWebhook": {
      "update_id": 123456789,
      "pre_checkout_query": {
        "id": "1234567890123456",
        "from": {
          "id": 123456789,
          "is_bot": false,
          "first_name": "John",
          "username": "john_doe"
        },
        "currency": "XTR",
        "total_amount": 500,
        "invoice_payload": "{\"userId\":\"123e4567-e89b-12d3-a456-426614174000\",\"productId\":\"credits_100\"}"
      }
    },
    "SuccessfulPaymentWebhook": {
      "update_id": 123456790,
      "message": {
        "message_id": 12345,
        "from": {
          "id": 123456789,
          "is_bot": false,
          "first_name": "John",
          "username": "john_doe"
        },
        "chat": {
          "id": 123456789,
          "type": "private"
        },
        "date": 1701964800,
        "successful_payment": {
          "currency": "XTR",
          "total_amount": 500,
          "invoice_payload": "{\"userId\":\"123e4567-e89b-12d3-a456-426614174000\",\"productId\":\"credits_100\"}",
          "telegram_payment_charge_id": "tg_charge_1A2B3C4D5E6F",
          "provider_payment_charge_id": ""
        }
      }
    }
  }
}
