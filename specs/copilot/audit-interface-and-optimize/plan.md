# Implementation Plan: UI/UX Improvements with Mobile-First Approach

**Branch**: `copilot/audit-interface-and-optimize` | **Date**: 2025-12-01 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/copilot/audit-interface-and-optimize/spec.md`

**Note**: This plan was generated by analyzing the current MusicVerse AI codebase and requirements.

## Summary

Comprehensive UI/UX redesign and optimization for MusicVerse AI platform focusing on mobile-first responsive design. Key improvements include:
- **Homepage**: Transform into public content discovery platform (streaming-like experience)
- **Generation Form**: Add AI Assistant mode with intelligent, context-aware guidance
- **Library**: Mobile-first redesign with smart versioning system (master version concept)
- **Track Details**: Fix lyrics display, improve version management, enhance AI analysis display
- **Track Actions**: Add persona creation, studio launcher, project/playlist management
- **Player**: Complete mobile optimization with queue management and playback logic

Technical approach uses React 19.2, TypeScript 5.9, Supabase, Radix UI, Tailwind CSS, and Framer Motion with mobile-first responsive design principles.

## Technical Context

**Language/Version**: TypeScript 5.9, React 19.2  
**Primary Dependencies**: 
- **UI**: Radix UI components, Tailwind CSS 3.4, Framer Motion 12.23
- **Backend**: Supabase 2.86 (PostgreSQL, Edge Functions, Realtime)
- **State**: Zustand 5.0, TanStack Query 5.90
- **Routing**: React Router 7.9
- **Build**: Vite 5.0, SWC

**Storage**: PostgreSQL (via Supabase) with tables: music_tracks, track_versions, track_stems, audio_analysis, music_projects, artists, playlists  
**Testing**: Jest 30.2, React Testing Library 16.3, Vitest 4.0 (browser testing with Playwright)  
**Target Platform**: Web (responsive PWA), Telegram Mini App, Mobile browsers (iOS Safari, Chrome Mobile)  
**Project Type**: Web application (single-page, mobile-first responsive design)  
**Performance Goals**: 
- Lighthouse mobile score: >90
- First Contentful Paint: <2s on 3G
- Component render time: <100ms
- Touch responsiveness: <100ms
- 60fps animations

**Constraints**: 
- Telegram Mini App limitations (WebView, specific APIs)
- Mobile bandwidth considerations (optimize assets)
- Touch target minimum: 44×44px
- Support for offline playback (future)
- API response time: <500ms p95

**Scale/Scope**: 
- ~50 components to modify/create
- 6 major feature areas
- ~10k lines of code changes
- Support for 10k+ concurrent users
- Mobile-first approach affecting all 15+ screens

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Tests**: 
- Unit tests for all new components (TrackCard, VersionSwitcher, Players, Assistant mode)
- Integration tests for version switching, queue management, public content discovery
- E2E tests for critical user flows (generation, playback, version management)
- Visual regression tests for responsive layouts
- Tests will be written following TDD approach for core functionality

✅ **Security & Privacy**: 
- Public content filtering via RLS policies (no private data leakage)
- User data isolation (own tracks, versions, playlists)
- No secrets in code (Supabase keys in env vars)
- Minimal data collection: only necessary for functionality
- Version switching logs only metadata, not full content
- Player state stored locally (no server-side tracking)

✅ **Observability**: 
- **Metrics**: Component render times, API latency (p95/p99), player load time, version switch time
- **Logs**: Version switch events, player state changes, generation form submissions, errors with context
- **Traces**: Full user journey from discovery → playback → version switching
- **Analytics**: GA4 events for feature usage (public content views, assistant mode usage, version switches)
- **Error Tracking**: Sentry integration for client errors with user context

✅ **Versioning & Migration**: 
- Database migrations with rollback scripts for schema changes
- Backward compatible API changes (new fields optional)
- Feature flags for gradual rollout of new UI components
- Migration plan for existing tracks to add master_version_id
- Changelog tracking for all version-related changes
- Semantic versioning for component library changes

## Project Structure

### Documentation (this feature)

```text
specs/copilot/audit-interface-and-optimize/
├── spec.md              # Feature specification (created)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 output (best practices, patterns)
├── data-model.md        # Phase 1 output (database schema, entities)
├── quickstart.md        # Phase 1 output (setup, usage guide)
├── contracts/           # Phase 1 output (API contracts, types)
│   ├── versioning-api.yaml
│   ├── public-content-api.yaml
│   ├── player-state.schema.json
│   └── assistant-form.schema.json
└── tasks.md             # Phase 2 output (NOT created by this command)
```

### Source Code (repository root)

```text
src/
├── pages/
│   ├── Index.tsx                    # MODIFIED: Homepage with public content
│   ├── Library.tsx                  # MODIFIED: Versioning system
│   └── Generate.tsx                 # MODIFIED: Assistant mode integration
│
├── components/
│   ├── home/                        # NEW: Homepage components
│   │   ├── FeaturedSection.tsx
│   │   ├── NewReleasesSection.tsx
│   │   ├── PopularSection.tsx
│   │   └── PublicTrackCard.tsx
│   │
│   ├── generate/                    # EXISTING + NEW
│   │   ├── GenerateHub.tsx          # MODIFIED
│   │   ├── SimpleMode.tsx           # EXISTING
│   │   ├── ProMode.tsx              # EXISTING
│   │   └── assistant/               # NEW: AI Assistant mode
│   │       ├── AssistantWizard.tsx
│   │       ├── StepPrompt.tsx
│   │       ├── StepStyle.tsx
│   │       ├── StepLyrics.tsx
│   │       ├── StepReference.tsx
│   │       ├── StepReview.tsx
│   │       └── FormHelper.tsx
│   │
│   ├── library/                     # NEW: Library components
│   │   ├── TrackCard.tsx            # MOVED & REDESIGNED (mobile-first)
│   │   ├── TrackRow.tsx             # NEW (compact list view)
│   │   ├── VersionSwitcher.tsx      # NEW
│   │   └── VersionBadge.tsx         # NEW
│   │
│   ├── track-detail/                # EXISTING + MODIFIED
│   │   ├── TrackDetailSheet.tsx     # MODIFIED
│   │   ├── TrackDetailsTab.tsx      # MODIFIED: version support
│   │   ├── TrackVersionsTab.tsx     # MODIFIED: improved UI
│   │   ├── TrackStemsTab.tsx        # MODIFIED: better display
│   │   ├── TrackAnalysisTab.tsx     # MODIFIED: improved parsing
│   │   └── TrackChangelogTab.tsx    # MODIFIED: version logs
│   │
│   ├── track-actions/               # EXISTING + NEW
│   │   ├── TrackActionsMenu.tsx     # MODIFIED
│   │   ├── TrackActionsSheet.tsx    # MODIFIED
│   │   ├── CreatePersonaDialog.tsx  # NEW
│   │   └── AddToProjectDialog.tsx   # NEW
│   │
│   ├── player/                      # NEW: Reorganized player
│   │   ├── CompactPlayer.tsx        # REDESIGNED (mobile-first)
│   │   ├── ExpandedPlayer.tsx       # NEW (intermediate state)
│   │   ├── FullscreenPlayer.tsx     # REDESIGNED (mobile optimized)
│   │   ├── PlaybackControls.tsx     # NEW (reusable controls)
│   │   ├── ProgressBar.tsx          # NEW
│   │   ├── VolumeControl.tsx        # NEW
│   │   ├── LyricsDisplay.tsx        # NEW (fixed sync)
│   │   └── QueueManager.tsx         # NEW
│   │
│   └── ui/                          # EXISTING (Radix components)
│
├── hooks/
│   ├── usePublicContent.ts          # NEW: Public content fetching
│   ├── useTrackVersions.ts          # EXISTING (modified)
│   ├── useVersionSwitcher.ts        # NEW: Version management
│   ├── usePlaybackQueue.ts          # NEW: Queue logic
│   ├── usePlayerState.ts            # MODIFIED: Enhanced state
│   └── useAssistantForm.ts          # NEW: Assistant form logic
│
├── lib/
│   ├── versioning.ts                # NEW: Version utilities
│   ├── player-utils.ts              # NEW: Player helpers
│   └── mobile-utils.ts              # NEW: Touch/responsive utils
│
└── integrations/supabase/
    ├── types.ts                     # MODIFIED: New types
    └── queries/
        ├── public-content.ts        # NEW
        ├── versioning.ts            # NEW
        └── changelog.ts             # NEW

supabase/migrations/
├── YYYYMMDDHHMMSS_add_master_version.sql
├── YYYYMMDDHHMMSS_add_version_fields.sql
├── YYYYMMDDHHMMSS_create_changelog_table.sql
└── YYYYMMDDHHMMSS_add_indexes.sql

tests/
├── unit/
│   ├── components/                  # Component unit tests
│   │   ├── library/
│   │   ├── player/
│   │   └── generate/
│   └── hooks/                       # Hook tests
│
├── integration/
│   ├── versioning.test.tsx          # Version switching flows
│   ├── playback.test.tsx            # Player integration
│   └── public-content.test.tsx      # Public discovery
│
└── e2e/
    ├── generation.spec.ts           # E2E generation flows
    ├── library.spec.ts              # E2E library interactions
    └── playback.spec.ts             # E2E playback scenarios
```

**Structure Decision**: Web application (single-page) with feature-based component organization. All frontend code in `src/`, backend logic in Supabase Edge Functions and database. Tests organized by type (unit/integration/e2e) with feature-specific subdirectories. Mobile-first responsive design across all components.

## Complexity Tracking

> **No Constitution violations identified**. All complexity is justified by user requirements and mobile-first approach.

**Justified Complexity**:

| Component | Complexity Reason | Justification |
|-----------|-------------------|---------------|
| Version System | Multiple versions per track with master concept | Required for A/B testing generations, user choice, avoiding clutter |
| Player States | 3 states (compact/expanded/fullscreen) | Essential for mobile UX, gradual engagement, space efficiency |
| Assistant Mode | Dynamic form with context-aware fields | Required for beginner-friendly generation, better UX than static form |
| Public Content | Separate queries and components | Security isolation, different data access patterns than user library |

**Alternatives Considered**:

- **Simple version list**: Rejected because creates visual clutter, confusing UX with 2+ versions per track
- **Single player state**: Rejected because poor mobile UX, wasted screen space, no gradual engagement
- **Static form**: Rejected because intimidating for beginners, doesn't guide users effectively
- **Mixed public/private content**: Rejected because security concerns, complex filtering, poor performance

---

## Phase 0: Outline & Research

### Research Tasks

1. **Mobile-First Design Patterns**
   - Best practices for touch interfaces (44×44px targets, spacing)
   - Swipe gesture patterns (dismissal, navigation)
   - Progressive disclosure patterns
   - Mobile performance optimization

2. **Audio Player UX**
   - Industry standards (Spotify, Apple Music, YouTube Music)
   - State transitions (compact → expanded → fullscreen)
   - Queue management patterns
   - Mobile-specific controls

3. **Version Management Systems**
   - Git-like versioning in UI (GitHub, GitLab)
   - Master/primary version concepts
   - Changelog display patterns
   - Version comparison visualizations

4. **Context-Aware Forms**
   - Conditional field display patterns
   - Step-by-step wizards vs. single-page forms
   - Inline validation and hints
   - Form state persistence

5. **Public Content Discovery**
   - Feed algorithms (chronological, popularity, personalized)
   - Filtering and sorting patterns
   - Preview/playback integration
   - Social features (likes, shares, remixes)

6. **Responsive Design Techniques**
   - Tailwind CSS responsive utilities
   - Framer Motion mobile animations
   - Touch event handling in React
   - Virtual scrolling for performance

### Research Output

File: `research.md` containing:
- Decision matrix for each research area
- Rationale for chosen approaches
- Alternatives considered and rejected
- Implementation examples and code snippets
- Performance considerations
- Accessibility guidelines

**Unknowns to Resolve**:
- Optimal player state transition triggers (swipe distance, velocity)
- Version switcher UI pattern (dropdown vs. sheet vs. inline)
- Assistant form step count (trade-off: guidance vs. speed)
- Public content ranking algorithm
- Mobile animation performance thresholds

---

## Phase 1: Design & Contracts

### 1.1 Data Model (`data-model.md`)

#### Entities

**Track (Extended)**
```typescript
interface Track {
  id: string;
  user_id: string;
  title: string;
  audio_url: string;
  cover_url: string;
  duration_seconds: number;
  is_public: boolean;
  master_version_id: string | null; // NEW: FK to track_versions
  lyrics: string | null;
  timestamped_lyrics: Json | null;
  metadata: Json;
  created_at: string;
  updated_at: string;
}
```

**TrackVersion (Extended)**
```typescript
interface TrackVersion {
  id: string;
  track_id: string;
  version_number: number; // NEW: Sequential version number
  is_master: boolean; // NEW: Is this the active version?
  version_type: 'original' | 'remix' | 'cover' | 'extended' | 'alternative';
  audio_url: string;
  cover_url: string | null;
  duration_seconds: number;
  metadata: Json;
  created_at: string;
}
```

**TrackChangelog (New)**
```typescript
interface TrackChangelog {
  id: string;
  track_id: string;
  version_id: string | null;
  change_type: 'version_created' | 'master_changed' | 'metadata_updated' | 'stem_generated';
  change_data: Json; // Details about the change
  user_id: string;
  created_at: string;
}
```

**PlaybackQueue (New, Client-side)**
```typescript
interface PlaybackQueue {
  current_track: Track;
  queue: Track[];
  history: Track[];
  repeat_mode: 'off' | 'one' | 'all';
  shuffle: boolean;
}
```

**PlayerState (New, Client-side)**
```typescript
interface PlayerState {
  track: Track | null;
  version: TrackVersion | null;
  state: 'compact' | 'expanded' | 'fullscreen';
  isPlaying: boolean;
  currentTime: number;
  volume: number;
  queue: PlaybackQueue;
}
```

#### Relationships

- Track → TrackVersion (1:many)
- Track → TrackVersion (master_version_id, 1:1)
- Track → TrackChangelog (1:many)
- Track → TrackStems (1:many)
- Track → AudioAnalysis (1:1)

#### Validation Rules

- `master_version_id` must reference existing version
- Only one version can have `is_master = true` per track
- `version_number` must be sequential and unique per track
- Public tracks must have valid audio_url and cover_url
- Track duration must match audio file duration (±2s tolerance)

### 1.2 API Contracts (`contracts/`)

#### Versioning API (`versioning-api.yaml`)

```yaml
openapi: 3.0.0
info:
  title: Track Versioning API
  version: 1.0.0

paths:
  /api/tracks/{trackId}/versions:
    get:
      summary: Get all versions of a track
      parameters:
        - name: trackId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of versions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TrackVersion'
  
  /api/tracks/{trackId}/versions/{versionId}/set-master:
    post:
      summary: Set a version as master
      parameters:
        - name: trackId
          in: path
          required: true
        - name: versionId
          in: path
          required: true
      responses:
        '200':
          description: Master version updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Track'

components:
  schemas:
    TrackVersion:
      type: object
      properties:
        id:
          type: string
        track_id:
          type: string
        version_number:
          type: integer
        is_master:
          type: boolean
        audio_url:
          type: string
        cover_url:
          type: string
        duration_seconds:
          type: number
```

#### Public Content API (`public-content-api.yaml`)

```yaml
openapi: 3.0.0
info:
  title: Public Content Discovery API
  version: 1.0.0

paths:
  /api/public/tracks:
    get:
      summary: Get public tracks
      parameters:
        - name: sort
          in: query
          schema:
            type: string
            enum: [recent, popular, trending]
        - name: genre
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of public tracks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PublicTrack'

  /api/public/projects:
    get:
      summary: Get public projects
      responses:
        '200':
          description: List of public projects

  /api/public/artists:
    get:
      summary: Get public artists
      responses:
        '200':
          description: List of public artists
```

#### Player State Schema (`player-state.schema.json`)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PlayerState",
  "type": "object",
  "properties": {
    "track": {
      "type": "object",
      "nullable": true
    },
    "version": {
      "type": "object",
      "nullable": true
    },
    "state": {
      "type": "string",
      "enum": ["compact", "expanded", "fullscreen"]
    },
    "isPlaying": {
      "type": "boolean"
    },
    "currentTime": {
      "type": "number",
      "minimum": 0
    },
    "volume": {
      "type": "number",
      "minimum": 0,
      "maximum": 1
    },
    "queue": {
      "type": "object",
      "properties": {
        "current_track": { "type": "object" },
        "queue": { "type": "array" },
        "history": { "type": "array" },
        "repeat_mode": {
          "type": "string",
          "enum": ["off", "one", "all"]
        },
        "shuffle": { "type": "boolean" }
      }
    }
  }
}
```

#### Assistant Form Schema (`assistant-form.schema.json`)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "AssistantFormState",
  "type": "object",
  "properties": {
    "step": {
      "type": "integer",
      "minimum": 1,
      "maximum": 5
    },
    "mode": {
      "type": "string",
      "enum": ["prompt", "style-lyrics", "cover", "extend", "project", "persona"]
    },
    "prompt": {
      "type": "string",
      "maxLength": 2000
    },
    "style": {
      "type": "string",
      "maxLength": 500
    },
    "lyrics": {
      "type": "string",
      "maxLength": 5000
    },
    "reference": {
      "type": "object",
      "properties": {
        "type": { "type": "string", "enum": ["audio", "track", "project"] },
        "url": { "type": "string" }
      }
    },
    "metadata": {
      "type": "object"
    }
  }
}
```

### 1.3 Quickstart Guide (`quickstart.md`)

```markdown
# UI/UX Improvements - Quickstart Guide

## Setup

1. **Database Migration**
   ```bash
   supabase migration up
   ```

2. **Install Dependencies**
   ```bash
   npm install
   ```

3. **Environment Variables**
   ```bash
   cp .env.example .env
   # Add Supabase keys
   ```

## Development

### Running Locally
```bash
npm run dev
```

### Testing
```bash
# Unit tests
npm test

# E2E tests
npm run test:e2e

# Coverage
npm run test:coverage
```

## Feature Usage

### 1. Version Management

```typescript
import { useVersionSwitcher } from '@/hooks/useVersionSwitcher';

function MyComponent() {
  const { versions, switchVersion, masterVersion } = useVersionSwitcher(trackId);
  
  return (
    <VersionSwitcher 
      versions={versions}
      current={masterVersion}
      onChange={switchVersion}
    />
  );
}
```

### 2. Public Content

```typescript
import { usePublicContent } from '@/hooks/usePublicContent';

function HomePage() {
  const { tracks, projects, artists } = usePublicContent({
    sort: 'popular',
    limit: 10
  });
  
  return <FeaturedSection items={tracks} />;
}
```

### 3. Player State

```typescript
import { usePlayerStore } from '@/hooks/usePlayerState';

function Player() {
  const { track, state, playTrack, setState } = usePlayerStore();
  
  return (
    <>
      {state === 'compact' && <CompactPlayer />}
      {state === 'expanded' && <ExpandedPlayer />}
      {state === 'fullscreen' && <FullscreenPlayer />}
    </>
  );
}
```

### 4. Assistant Mode

```typescript
import { AssistantWizard } from '@/components/generate/assistant/AssistantWizard';

function Generate() {
  return (
    <GenerateHub>
      <AssistantWizard onComplete={handleGenerate} />
    </GenerateHub>
  );
}
```

## Mobile Testing

```bash
# Test on mobile device
npm run dev -- --host

# Access from mobile: http://<your-ip>:5173
```

## Deployment

```bash
npm run build
npm run preview
```
```

### 1.4 Agent Context Update

Run the agent context update script:

```bash
.specify/scripts/powershell/update-agent-context.ps1 -AgentType copilot
```

This will add:
- New versioning patterns
- Mobile-first design principles
- Player state management patterns
- Public content discovery patterns

---

## Phase 2: Implementation Plan Summary

**This phase is NOT executed by this command.** Implementation will be broken down in `tasks.md` created by `/speckit.tasks`.

### Implementation Phases Overview

#### Week 1: Database & Infrastructure
- Database schema migrations
- Core hooks (versioning, public content, player state)
- Type system updates

#### Week 2-3: Component Development
- Library components (TrackCard, versioning)
- Player components (3 states)
- Track detail improvements
- Track actions expansion
- Homepage redesign

#### Week 4: Assistant Mode
- AssistantWizard and step components
- Form state management
- Integration with GenerateHub

#### Week 5: Testing & Polish
- Unit/integration/E2E tests
- Mobile testing
- Performance optimization
- Accessibility audit

### Key Deliverables

1. **Database Migrations**: 4 migration files
2. **New Components**: ~20 components
3. **Modified Components**: ~15 components
4. **Hooks**: 5 new, 3 modified
5. **Tests**: 50+ test files
6. **Documentation**: API contracts, user guides

### Success Criteria

- ✅ All Constitution checks pass
- ✅ Lighthouse mobile score >90
- ✅ Test coverage >80%
- ✅ Zero accessibility violations
- ✅ API response <500ms p95
- ✅ Touch targets ≥44×44px
- ✅ Smooth 60fps animations

---

## Next Steps

1. **Run Phase 0**: Research best practices and patterns
2. **Generate Contracts**: Complete API documentation
3. **Create Tasks**: Break down into implementable tasks (`/speckit.tasks`)
4. **Begin Implementation**: Follow task order with TDD approach
