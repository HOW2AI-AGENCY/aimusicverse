# –ê–£–î–ò–¢ –°–ò–°–¢–ï–ú–´ –ì–ï–ù–ï–†–ê–¶–ò–ò –¢–†–ï–ö–û–í - AIMusverse
**–î–∞—Ç–∞:** 2025-12-12
**–í–µ—Ä—Å–∏—è:** 1.0
**–°—Ç–∞—Ç—É—Å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´

---

## üìã –ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï

–ü—Ä–æ–≤–µ–¥–µ–Ω –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–∫–æ–≤ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏ **cover (–∫–∞–≤–µ—Ä)** –∏ **extend (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)**. –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã **—Å–µ—Ä—å–µ–∑–Ω—ã–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏**, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ **–ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ—Ä–∞–±–æ—á–∏–º–∏**.

### –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:
- üî¥ **12 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤** –≤ –ª–æ–≥–∏–∫–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- üü† **8 –≤–∞–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º** —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
- üü° **6 –ø—Ä–æ–±–ª–µ–º –¥–∏–∑–∞–π–Ω–∞** —Å –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å—é —Ç—Ä–µ–∫–æ–≤ –∏ –º–æ–¥–µ–ª—è–º–∏
- ‚ö†Ô∏è **–§—É–Ω–∫—Ü–∏–∏ cover –∏ extend –ù–ï –†–ê–ë–û–¢–ê–Æ–¢** –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## üéØ –ú–ï–¢–û–î–û–õ–û–ì–ò–Ø –ê–£–î–ò–¢–ê

1. **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞:**
   - –í—Å–µ Edge Functions –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
   - React —Ö—É–∫–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
   - Telegram bot handlers

2. **–ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö:**
   - –û—Ç UI –¥–æ Suno API
   - Callback –æ–±—Ä–∞–±–æ—Ç–∫–∞
   - Database —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏:**
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 –ö–õ–ò–ï–ù–¢–°–ö–ò–ô –°–õ–û–ô                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ  React App:                Telegram Bot:            ‚îÇ
‚îÇ  - useGenerateForm.ts      - generate.ts            ‚îÇ
‚îÇ  - UploadAudioDialog       - audio-upload.ts        ‚îÇ
‚îÇ                            - audio.ts (handler)     ‚îÇ
‚îÇ                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              SUPABASE EDGE FUNCTIONS                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                     ‚îÇ
‚îÇ  Generation:                                        ‚îÇ
‚îÇ  - suno-music-generate     [‚úÖ –†–ê–ë–û–¢–ê–ï–¢]           ‚îÇ
‚îÇ  - suno-upload-cover       [üî¥ –ù–ï –†–ê–ë–û–¢–ê–ï–¢]        ‚îÇ
‚îÇ  - suno-upload-extend      [üî¥ –ù–ï –†–ê–ë–û–¢–ê–ï–¢]        ‚îÇ
‚îÇ  - suno-music-extend       [üî¥ –ù–ï –†–ê–ë–û–¢–ê–ï–¢]        ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  Callback:                                          ‚îÇ
‚îÇ  - suno-music-callback     [‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–´]           ‚îÇ
‚îÇ                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  SUNO API                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  - /api/v1/generate                                 ‚îÇ
‚îÇ  - /api/v1/generate/upload-cover                    ‚îÇ
‚îÇ  - /api/v1/generate/upload-extend                   ‚îÇ
‚îÇ  - /api/v1/generate/extend                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #1: –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ defaultParamFlag –≤ useGenerateForm
**–§–∞–π–ª:** `src/hooks/generation/useGenerateForm.ts:558`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø
**–°—Ç–∞—Ç—É—Å:** –°–ò–°–¢–ï–ú–ê –ù–ï –†–ê–ë–û–¢–ê–ï–¢

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const result = await supabase.functions.invoke('suno-upload-extend', {
  body: {
    // ...
    defaultParamFlag: mode === 'custom',  // ‚ùå –û–®–ò–ë–ö–ê!
    // ...
  },
});
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
- `defaultParamFlag: true` –æ–∑–Ω–∞—á–∞–µ—Ç "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ** –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞"
- `mode === 'custom'` –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **—Ö–æ—á–µ—Ç —É–∫–∞–∑–∞—Ç—å –°–í–û–ò –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**
- **–õ–æ–≥–∏–∫–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!** –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç custom, —Å–∏—Å—Ç–µ–º–∞ –≥–æ–≤–æ—Ä–∏—Ç Suno API –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:**
```typescript
defaultParamFlag: mode !== 'custom',  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã —Ç–æ–ª—å–∫–æ –≤ simple mode
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –í—Å–µ extend –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç style, lyrics, –Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥–µ—Ç —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- –§—É–Ω–∫—Ü–∏—è extend **–ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ—Ä–∞–±–æ—á–∞—è**

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #2: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ cover vs extend
**–§–∞–π–ª—ã:**
- `supabase/functions/suno-upload-cover/index.ts:170`
- `supabase/functions/suno-upload-extend/index.ts:177`

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// suno-upload-cover.ts
const requestBody = {
  uploadUrl: publicUrl,
  customMode,  // ‚Üê –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è customMode
  instrumental,
  // ...
};

// suno-upload-extend.ts
const requestBody = {
  uploadUrl: publicUrl,
  defaultParamFlag,  // ‚Üê –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è defaultParamFlag
  // ...
};
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
- –û–±–∞ endpoint –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π Suno API –º–µ—Ö–∞–Ω–∏–∑–º**
- –ù–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **—Ä–∞–∑–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
- `customMode` (cover) vs `defaultParamFlag` (extend)
- –≠—Ç–æ **—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–µ** –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
  - `customMode: true` = "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
  - `defaultParamFlag: true` = "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Suno API:**
–°–æ–≥–ª–∞—Å–Ω–æ https://docs.sunoapi.org, –¥–ª—è –æ–±–æ–∏—Ö endpoints –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä **`customMode`**.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –û–¥–∏–Ω –∏–∑ endpoints –ø–µ—Ä–µ–¥–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
- Suno API –ª–∏–±–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä, –ª–∏–±–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É
- Inconsistency –≤ –∫–æ–¥–µ, —Å–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #3: –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–∞—è –ª–æ–≥–∏–∫–∞ –≤ audio.ts handler
**–§–∞–π–ª:** `supabase/functions/telegram-bot/handlers/audio.ts:438-451`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
if (isExtend) {
  requestBody.defaultParamFlag = true;  // ‚ùå –ì–æ–≤–æ—Ä–∏–º "–∏—Å–ø–æ–ª—å–∑—É–π –¥–µ—Ñ–æ–ª—Ç—ã"
  requestBody.instrumental = pendingUpload.instrumental || false;
  if (pendingUpload.style) requestBody.style = pendingUpload.style;  // ‚ùå –ù–æ –ø–µ—Ä–µ–¥–∞–µ–º custom style!
  if (pendingUpload.title) requestBody.title = pendingUpload.title;  // ‚ùå –ò custom title!
  if (pendingUpload.prompt && !pendingUpload.instrumental) {
    requestBody.prompt = pendingUpload.prompt;  // ‚ùå –ò custom prompt!
  }
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
- `defaultParamFlag: true` –æ–∑–Ω–∞—á–∞–µ—Ç "–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ custom –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
- –ù–æ –∑–∞—Ç–µ–º –∫–æ–¥ **–ø–µ—Ä–µ–¥–∞–µ—Ç custom –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** (style, title, prompt)
- Suno API **–ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã** –ø–æ—Ç–æ–º—É —á—Ç–æ defaultParamFlag=true
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑—ã–≤–∞–µ—Ç style, –Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–¥–µ—Ç **–±–µ–∑ —É—á–µ—Ç–∞ style**

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:**
```typescript
if (isExtend) {
  // –ï—Å–ª–∏ –µ—Å—Ç—å custom –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã
  const hasCustomParams = pendingUpload.style || pendingUpload.title || pendingUpload.prompt;
  requestBody.defaultParamFlag = !hasCustomParams;
  // ... –∑–∞—Ç–µ–º –ø–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- **–í—Å–µ extend –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ Telegram –±–æ—Ç–∞ –ù–ï –†–ê–ë–û–¢–ê–Æ–¢**
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–∂–∏–¥–∞–Ω–∏—è–º

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #4: –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏ –æ—à–∏–±–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
**–§–∞–π–ª:** `supabase/functions/suno-music-extend/index.ts:94-184`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞ 4a - –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è:**
```typescript
const useCustomParams = !defaultParamFlag;  // Line 94
// ... –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å–æ–∑–¥–∞–µ—Ç—Å—è, –Ω–æ –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –Ω–∏–≥–¥–µ!
```

**–ü—Ä–æ–±–ª–µ–º–∞ 4b - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```typescript
// suno-upload-extend.ts:182
if (defaultParamFlag) {  // ‚ùå –ü—Ä–æ–≤–µ—Ä—è–µ–º "–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã"
  // Custom mode
  if (!style) {
    return new Response(
      JSON.stringify({ error: 'Style is required in custom mode' }),
      // ‚ùå –ù–æ —Ç—Ä–µ–±—É–µ–º style –¥–ª—è "–¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞"!
    );
  }
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
- `defaultParamFlag: true` –æ–∑–Ω–∞—á–∞–µ—Ç "–∏—Å–ø–æ–ª—å–∑—É–π –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
- –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ **—Ç—Ä–µ–±—É–µ—Ç style**, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è **custom –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º**
- –õ–æ–≥–∏–∫–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å `if (!defaultParamFlag)`

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:**
```typescript
if (!defaultParamFlag) {  // ‚úÖ –ï—Å–ª–∏ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç—ã (—Ç.–µ. custom mode)
  if (!style) {
    return new Response(
      JSON.stringify({ error: 'Style is required in custom mode' }),
      { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è **–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ**
- –í custom mode –º–æ–∂–µ—Ç –ø—Ä–æ–π—Ç–∏ –∑–∞–ø—Ä–æ—Å **–±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ style**
- –í default mode –≤–∞–ª–∏–¥–∞—Ü–∏—è **—Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω—ã**

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #5: customMode –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–ª–∏—á–∏—è style
**–§–∞–π–ª:** `supabase/functions/telegram-bot/handlers/audio.ts:446`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
} else {
  // Cover mode
  requestBody.customMode = Boolean(pendingUpload.style);  // ‚ùå –û–®–ò–ë–ö–ê!
  requestBody.instrumental = pendingUpload.instrumental || false;
  if (pendingUpload.style) requestBody.style = pendingUpload.style;
  if (pendingUpload.prompt) requestBody.prompt = pendingUpload.prompt;
  if (pendingUpload.title) requestBody.title = pendingUpload.title;
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
- `customMode` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–∏–µ–º `style`
- –ù–æ custom –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∫–ª—é—á–∞—é—Ç —Ç–∞–∫–∂–µ `prompt` –∏ `title`!
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª **—Ç–æ–ª—å–∫–æ prompt –±–µ–∑ style**, —Ç–æ:
  - `customMode = false` (–Ω–µ—Ç style)
  - `requestBody.prompt = pendingUpload.prompt` (–ø–µ—Ä–µ–¥–∞–µ–º prompt)
  - Suno API **–ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç prompt**, –ø–æ—Ç–æ–º—É —á—Ç–æ `customMode: false`

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:**
```typescript
const hasCustomParams = pendingUpload.style || pendingUpload.prompt || pendingUpload.title;
requestBody.customMode = hasCustomParams;
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- **Cover —Å prompt –Ω–æ –±–µ–∑ style –ù–ï –†–ê–ë–û–¢–ê–ï–¢**
- Prompt –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê #6: Telegram bot generate –ø–µ—Ä–µ–¥–∞–µ—Ç prompt –∫–∞–∫ style
**–§–∞–π–ª:** `supabase/functions/telegram-bot/commands/generate.ts:167`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const { data, error: generateError } = await supabase.functions.invoke('suno-music-generate', {
  body: {
    mode,
    instrumental,
    model,
    prompt: actualPrompt,
    style: mode === 'custom' ? actualPrompt : undefined,  // ‚ùå prompt –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ style!
  },
});
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
- –í custom mode –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã **—Ä–∞–∑–Ω—ã–µ** –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
  - `prompt` = —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ (lyrics)
  - `style` = –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å (–∂–∞–Ω—Ä, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ)
- –ù–æ –∫–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç **–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç** –¥–ª—è –æ–±–æ–∏—Ö!
- `actualPrompt` –∏–¥–µ—Ç –∏ –∫–∞–∫ `prompt`, –∏ –∫–∞–∫ `style`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- **Custom –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ Telegram –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**
- –¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
- Suno API –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

---

## üü† –í–ê–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê #7: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ upload-cover –∏ upload-extend
**–§–∞–π–ª—ã:**
- `supabase/functions/suno-upload-cover/index.ts` - –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
- `supabase/functions/suno-upload-extend/index.ts` - –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
- `supabase/functions/suno-music-generate/index.ts:132` - –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚úÖ

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü† –í–ê–ñ–ù–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
–¢–æ–ª—å–∫–æ `suno-music-generate` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –∫—Ä–µ–¥–∏—Ç–æ–≤ **–ø–µ—Ä–µ–¥** –≤—ã–∑–æ–≤–æ–º Suno API:

```typescript
// suno-music-generate.ts:132
if (!isAdmin) {
  const { data: userCredits } = await supabase
    .from('user_credits')
    .select('balance')
    .eq('user_id', user.id)
    .maybeSingle();

  const userBalance = userCredits?.balance ?? 0;

  if (userBalance < GENERATION_COST) {
    return new Response(
      JSON.stringify({
        success: false,
        error: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤. –ë–∞–ª–∞–Ω—Å: ${userBalance}, —Ç—Ä–µ–±—É–µ—Ç—Å—è: ${GENERATION_COST}`,
      }),
      { status: 402 }
    );
  }
}
```

**–ê –≤ upload-cover –∏ upload-extend —ç—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ù–ï–¢!**

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å cover/extend **–±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤**
- –ó–∞–ø—Ä–æ—Å –ø–æ–π–¥–µ—Ç –∫ Suno API
- –°–æ–∑–¥–∞—Å—Ç—Å—è task –∏ track –≤ –ë–î
- –ó–∞—Ç–µ–º Suno API –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É "insufficient credits"
- Task –∏ track –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ failed
- **–î–µ–Ω—å–≥–∏ –ù–ï –¥–µ–±—è—Ç—Å—è** (callback –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è failed)
- –ù–æ **–º—É—Å–æ—Ä–Ω—ã–µ –∑–∞–ø–∏—Å–∏** –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ë–î

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ upload-cover –∏ upload-extend –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ suno-music-generate.

---

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê #8: Race condition –ø—Ä–∏ –¥–µ–±–µ—Ç–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
**–§–∞–π–ª:** `supabase/functions/suno-music-callback/index.ts:437-463`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü† –í–ê–ñ–ù–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// Line 437
if (!isAdmin) {
  // Deduct credits from user balance
  const { data: currentCredits } = await supabase
    .from('user_credits')
    .select('balance, total_spent')
    .eq('user_id', task.user_id)
    .single();

  if (currentCredits) {
    const newBalance = Math.max(0, currentCredits.balance - GENERATION_COST);

    // ‚ùå Race condition –∑–¥–µ—Å—å!
    const { error: updateError } = await supabase
      .from('user_credits')
      .update({
        balance: newBalance,
        total_spent: newTotalSpent,
      })
      .eq('user_id', task.user_id);
  }
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- –ú–µ–∂–¥—É `SELECT balance` –∏ `UPDATE balance` –º–æ–∂–µ—Ç –ø—Ä–æ–π—Ç–∏ –≤—Ä–µ–º—è
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å—Ç–∏—Ç **–¥–≤–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**, –æ–±–µ:
  1. –ü—Ä–æ—á–∏—Ç–∞—é—Ç `balance = 50`
  2. –û–±–µ –ø—Ä–æ–π–¥—É—Ç –ø—Ä–æ–≤–µ—Ä–∫—É (50 >= 10)
  3. –°–æ–∑–¥–∞–¥—É—Ç –¥–≤–∞ task
  4. –û–±–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
  5. Callback 1: –ø—Ä–æ—á–∏—Ç–∞–µ—Ç balance=50, –æ–±–Ω–æ–≤–∏—Ç –Ω–∞ 40
  6. Callback 2: –ø—Ä–æ—á–∏—Ç–∞–µ—Ç balance=40, –æ–±–Ω–æ–≤–∏—Ç –Ω–∞ 30
  7. **–†–µ–∑—É–ª—å—Ç–∞—Ç: –±–∞–ª–∞–Ω—Å 30 –≤–º–µ—Å—Ç–æ 30** ‚Üê —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É—á—Ç–µ–Ω–∞!

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –∏–ª–∏ **database lock**:

```sql
-- –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
UPDATE user_credits
SET
  balance = GREATEST(0, balance - 10),
  total_spent = total_spent + 10
WHERE user_id = $1
RETURNING balance;
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **RPC —Ñ—É–Ω–∫—Ü–∏—é** —Å transaction lock.

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- **–ü–æ—Ç–µ—Ä—è —É—á–µ—Ç–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ —á–µ–º –∏–º–µ–µ—Ç
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏

---

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê #9: –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ audioFile –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
**–§–∞–π–ª:** `src/hooks/generation/useGenerateForm.ts:531-549`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü† –í–ê–ñ–ù–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
if (audioFile) {
  const fileData = await new Promise<string>((resolve, reject) => {
    const reader = new FileReader();
    const timeout = setTimeout(() => {
      reader.abort();
      reject(new Error('File reading timeout'));  // ‚Üê Timeout 30 —Å–µ–∫
    }, FILE_READER_TIMEOUT);

    reader.onload = () => {
      clearTimeout(timeout);
      resolve(reader.result as string);
    };
    // ...
    reader.readAsDataURL(audioFile);  // ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞!
  });
}
```

**–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞:** `FILE_READER_TIMEOUT = 30000` (30 —Å–µ–∫—É–Ω–¥)

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ **–ø–µ—Ä–µ–¥** —á—Ç–µ–Ω–∏–µ–º
- –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (> 50MB) –º–æ–≥—É—Ç:
  - –ü—Ä–µ–≤—ã—Å–∏—Ç—å timeout 30 —Å–µ–∫
  - –í—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É "File reading timeout"
  - –°—ä–µ—Å—Ç—å –ø–∞–º—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞
- Telegram bot –ø—Ä–æ–≤–µ—Ä—è–µ—Ç (25MB limit –Ω–∞ line 85 audio.ts)
- –ù–æ React app **–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
if (audioFile) {
  const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB

  if (audioFile.size > MAX_FILE_SIZE) {
    toast.error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π', {
      description: `–ú–∞–∫—Å–∏–º—É–º ${MAX_FILE_SIZE / 1024 / 1024}MB`,
    });
    return;
  }

  // ... –∑–∞—Ç–µ–º —á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü–ª–æ—Ö–æ–π UX (–¥–æ–ª–≥–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –∑–∞—Ç–µ–º –æ—à–∏–±–∫–∞)
- –¢—Ä–∞—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
- –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é

---

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê #10: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ DEFAULT_MODEL –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
**–§–∞–π–ª—ã:**
- `suno-music-generate/index.ts:18` ‚Üí `DEFAULT_MODEL = 'V4_5'`
- `suno-music-extend/index.ts:17` ‚Üí `DEFAULT_MODEL = 'V4_5PLUS'` ‚ùå
- `suno-upload-cover/index.ts:17` ‚Üí `DEFAULT_MODEL = 'V4_5'`
- `suno-upload-extend/index.ts:17` ‚Üí `DEFAULT_MODEL = 'V4_5'`

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü† –í–ê–ñ–ù–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
- **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏** –≤ suno-music-extend
- –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `V4_5`, –∫—Ä–æ–º–µ extend –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `V4_5PLUS`
- –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ **—Ä–∞–∑–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º** –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Inconsistency –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏
- –°–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–¥–∫–∞
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Ä–∞–∑–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã (PLUS –¥–æ—Ä–æ–∂–µ?)

---

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê #11: –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è callback –º–æ–≥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è –¥–≤–∞–∂–¥—ã
**–§–∞–π–ª:** `supabase/functions/suno-music-callback/index.ts:63-69`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü† –í–ê–ñ–ù–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// Line 63
if (task.status === 'completed' && callbackType === 'complete') {
  logger.warn('Duplicate completion callback', { sunoTaskId });
  return new Response(
    JSON.stringify({ success: true, status: 'already_processed' }),
    { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
  );
}
```

**–ó–∞—â–∏—Ç–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è `status === 'completed'`
- –ï—Å–ª–∏ callback –ø—Ä–∏—Ö–æ–¥–∏—Ç **–¥–æ** –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ –ë–î:
  1. Callback 1 –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
  2. Callback 2 (–¥—É–±–ª–∏–∫–∞—Ç) –ø—Ä–∏—Ö–æ–¥–∏—Ç **–¥–æ** —Ç–æ–≥–æ –∫–∞–∫ Callback 1 –æ–±–Ω–æ–≤–∏–ª —Å—Ç–∞—Ç—É—Å
  3. –û–±–∞ –≤–∏–¥—è—Ç `status = 'processing'`
  4. –û–±–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –ø—Ä–æ–≤–µ—Ä–∫—É
  5. **–û–±–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è!**

**Race condition window:** –≤—Ä–µ–º—è –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- **–î–≤–æ–π–Ω–æ–π –¥–µ–±–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤**
- –î–≤–æ–π–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è track_versions

**–†–µ—à–µ–Ω–∏–µ:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **database lock** –∏–ª–∏ **unique constraint** –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É callback.

---

### ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê #12: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö download audio
**–§–∞–π–ª:** `supabase/functions/suno-music-callback/index.ts:313-327`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü† –í–ê–ñ–ù–ê–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
try {
  const audioResponse = await fetch(audioUrl);
  if (audioResponse.ok) {
    const audioBlob = await audioResponse.blob();
    // ... upload to storage
  }
} catch (e) {
  logger.error('Download error for clip', e, { clipIndex: i });
  // ‚ùå –ù–µ—Ç retry! –ü—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- Download –æ—Ç Suno –º–æ–∂–µ—Ç **–≤—Ä–µ–º–µ–Ω–Ω–æ** –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å
- –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å **intermittent**
- –ï—Å–ª–∏ download failed, track **–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∞—É–¥–∏–æ**
  - `localAudioUrl = null`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ Suno URL (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–º)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É —Å exponential backoff:

```typescript
const maxRetries = 3;
for (let attempt = 0; attempt < maxRetries; attempt++) {
  try {
    const audioResponse = await fetch(audioUrl);
    if (audioResponse.ok) {
      // success
      break;
    }
  } catch (e) {
    if (attempt === maxRetries - 1) throw e;
    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
  }
}
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –¢—Ä–µ–∫–∏ –±–µ–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞—É–¥–∏–æ
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Suno CDN
- –í–æ–∑–º–æ–∂–Ω–∞—è –ø–æ—Ç–µ—Ä—è —Ç—Ä–µ–∫–æ–≤ –µ—Å–ª–∏ Suno —É–¥–∞–ª–∏—Ç —Ñ–∞–π–ª—ã

---

## üü° –ü–†–û–ë–õ–ï–ú–´ –î–ò–ó–ê–ô–ù–ê

### üí° –ü–†–û–ë–õ–ï–ú–ê #13: –í—Å–µ —Ç—Ä–µ–∫–∏ –ø—É–±–ª–∏—á–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
**–§–∞–π–ª:** `supabase/functions/suno-music-generate/index.ts:272`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –î–ò–ó–ê–ô–ù

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const { data: track } = await supabase
  .from('tracks')
  .insert({
    // ...
    is_public: true,  // ‚ùå –í–°–ï —Ç—Ä–µ–∫–∏ –ø—É–±–ª–∏—á–Ω—ã–µ!
    // ...
  })
```

**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –∫–æ–¥–µ (line 272):**
```typescript
// ALL tracks are public by default for community discovery
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π:**
- –ù–µ—Ç **–≤—ã–±–æ—Ä–∞** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å **–ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Ç—Ä–µ–∫–∏**
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ö–æ—Ç–µ—Ç—å **—Å–∫—Ä—ã—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏—é –≤ UI –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ API:
```typescript
is_public: body.isPublic ?? true,  // –î–µ—Ñ–æ–ª—Ç true, –Ω–æ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
```

---

### üí° –ü–†–û–ë–õ–ï–ú–ê #14: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–ª–µ is_primary –≤ track_versions
**–§–∞–π–ª:** `supabase/functions/suno-music-callback/index.ts:362`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –î–ò–ó–ê–ô–ù

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
const { data: newVersion } = await supabase.from('track_versions').insert({
  track_id: trackId,
  // ...
  is_primary: i === 0,  // –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è primary
}).select().single();

if (newVersion && i === 0) {
  await supabase.from('tracks')
    .update({ active_version_id: newVersion.id })
    .eq('id', trackId)
    .is('active_version_id', null);  // ‚ùå –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ active_version_id === null!
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- –£—Å–ª–æ–≤–∏–µ `.is('active_version_id', null)` –æ–∑–Ω–∞—á–∞–µ—Ç:
  - –û–±–Ω–æ–≤–∏—Ç—å active_version_id **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏** –æ–Ω **–µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**
- –ù–æ –∑–∞—Ç–µ–º —Å–æ–∑–¥–∞—é—Ç—Å—è –≤–µ—Ä—Å–∏–∏ B, C, D —Å `is_primary: false`
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ—á–µ—Ç **–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å primary –≤–µ—Ä—Å–∏—é**, –Ω–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- active_version_id —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
- is_primary flag –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –≤–µ—Ä—Å–∏—é –∫–∞–∫ primary

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å endpoint –¥–ª—è —Å–º–µ–Ω—ã active_version –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å is_primary –¥–ª—è UI –∏–Ω–¥–∏–∫–∞—Ü–∏–∏.

---

### üí° –ü–†–û–ë–õ–ï–ú–ê #15: –°–º–µ—à–∏–≤–∞–Ω–∏–µ –¥–≤—É—Ö —Å–∏—Å—Ç–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
**–§–∞–π–ª—ã:**
- `suno-upload-cover/index.ts:71-113`
- `suno-upload-extend/index.ts:71-113`

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –î–ò–ó–ê–ô–ù

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
if (source === 'telegram_bot') {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ x-telegram-bot-secret header
  const botSecret = req.headers.get('x-telegram-bot-secret');
  if (!botSecret || botSecret !== telegramBotSecret) {
    return new Response(/* 401 Unauthorized */);
  }
  userId = telegramUserId;  // ‚Üê userId –∏–∑ body
} else {
  // Standard JWT auth
  const authHeader = req.headers.get('Authorization');
  const { data: { user } } = await supabase.auth.getUser(token);
  userId = user.id;  // ‚Üê userId –∏–∑ JWT
}
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- **–î–≤–∞ —Ä–∞–∑–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞** –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
- Telegram bot –ø–µ—Ä–µ–¥–∞–µ—Ç userId **–≤ body** (–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –∑–Ω–∞—Ç—å secret)
- Web app –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JWT (–±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å:** –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ —É–∑–Ω–∞–µ—Ç TELEGRAM_BOT_TOKEN, –º–æ–∂–µ—Ç:
  - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å `source: 'telegram_bot'`
  - –ü–µ—Ä–µ–¥–∞—Ç—å `userId` –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏ **–æ—Ç –∏–º–µ–Ω–∏ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- Telegram bot –¥–æ–ª–∂–µ–Ω —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service role JWT
- –ò–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é (check telegram_id –≤ profiles)

---

### üí° –ü–†–û–ë–õ–ï–ú–ê #16: –ù–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
**–í—Å–µ —Ñ–∞–π–ª—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏**
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –î–ò–ó–ê–ô–ù

**–ü—Ä–æ–±–ª–µ–º–∞:**
–†–∞–∑–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è **–æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ** –∫–æ–Ω—Ü–µ–ø—Ç–∞:

| –§–∞–π–ª | –ü–∞—Ä–∞–º–µ—Ç—Ä "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å custom –ø–∞—Ä–∞–º–µ—Ç—Ä—ã" |
|------|-------------------------------------------|
| suno-upload-cover | `customMode: boolean` |
| suno-upload-extend | `defaultParamFlag: boolean` (–∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π!) |
| suno-music-extend | `defaultParamFlag: boolean` (–∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π!) |
| useGenerateForm | `mode: 'simple' | 'custom'` |

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- **–ü—É—Ç–∞–Ω–∏—Ü–∞** –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∫–æ–¥–∞
- **–û—à–∏–±–∫–∏** –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ –ø—Ä–æ–±–ª–µ–º–∞—Ö –≤—ã—à–µ)
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ **–æ–¥–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ**:
```typescript
interface GenerationRequest {
  mode: 'simple' | 'custom';  // ‚úÖ –ï–¥–∏–Ω–æ–µ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
}
```

---

### üí° –ü–†–û–ë–õ–ï–ú–ê #17: Timeout –¥–ª—è FileReader –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º
**–§–∞–π–ª:** `src/hooks/generation/useGenerateForm.ts:536`
**–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞:** `FILE_READER_TIMEOUT = 30000` (30 —Å–µ–∫)

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –î–ò–ó–ê–ô–ù

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Timeout 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
- –î–ª—è **–±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤** –Ω–∞ **–º–µ–¥–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö** –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- –û—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Ñ–∞–π–ª > 20MB –∏ –∏–¥–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ base64

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –£–≤–µ–ª–∏—á–∏—Ç—å timeout –¥–æ 60 —Å–µ–∫
- –ò–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å progress bar
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å chunked upload –≤–º–µ—Å—Ç–æ base64

---

### üí° –ü–†–û–ë–õ–ï–ú–ê #18: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
**–§–∞–π–ª:** `supabase/functions/suno-music-callback/index.ts:288-398`
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** üü° –î–ò–ó–ê–ô–ù

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// –°–æ–∑–¥–∞—é—Ç—Å—è track_versions –¥–ª—è –∫–∞–∂–¥–æ–≥–æ clip
for (let i = 0; i < clips.length; i++) {
  // ...
  await supabase.from('track_versions').insert({
    track_id: trackId,
    version_type: 'initial',  // ‚Üê –í—Å–µ "initial"
    version_label: versionLabel,  // A, B, C
    // ...
  });
}

// –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ì–õ–ê–í–ù–´–ô track —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–º –∫–ª–∏–ø–æ–º
await supabase.from('tracks').update({
  status: 'completed',
  audio_url: finalAudioUrl,  // ‚Üê –¢–æ–ª—å–∫–æ clip[0]
  // ...
}).eq('id', trackId);
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- –ì–ª–∞–≤–Ω—ã–π track **–≤—Å–µ–≥–¥–∞** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏—é A
- –í–µ—Ä—Å–∏–∏ B, C, D —Å–æ–∑–¥–∞—é—Ç—Å—è, –Ω–æ **–Ω–µ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏**
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ **–ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å** track.audio_url –Ω–∞ –≤–µ—Ä—Å–∏—é B
- –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π track.audio_url

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å **–∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–∏–ª –≤–µ—Ä—Å–∏—é**
- –ù–µ—Ç **changelog** –¥–ª—è track
- –°–ª–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å **–∫–∞–∫–∞—è –≤–µ—Ä—Å–∏—è –±—ã–ª–∞ active –≤ –∫–∞–∫–æ–π –º–æ–º–µ–Ω—Ç**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–î–æ–±–∞–≤–∏—Ç—å track_change_log –ø—Ä–∏ —Å–º–µ–Ω–µ active_version.

---

## üìä –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### üî¥ –ù–ï–ú–ï–î–õ–ï–ù–ù–û (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ - –±–ª–æ–∫–∏—Ä—É—é—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
1. **–ü—Ä–æ–±–ª–µ–º–∞ #1** - –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ defaultParamFlag –≤ useGenerateForm
2. **–ü—Ä–æ–±–ª–µ–º–∞ #3** - –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–∞—è –ª–æ–≥–∏–∫–∞ –≤ audio.ts handler
3. **–ü—Ä–æ–±–ª–µ–º–∞ #4** - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ defaultParamFlag –≤ upload-extend
4. **–ü—Ä–æ–±–ª–µ–º–∞ #5** - customMode –∑–∞–≤–∏—Å–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç style
5. **–ü—Ä–æ–±–ª–µ–º–∞ #6** - Telegram bot –ø–µ—Ä–µ–¥–∞–µ—Ç prompt –∫–∞–∫ style

### üü† –í –ë–õ–ò–ñ–ê–ô–®–ï–ï –í–†–ï–ú–Ø (–í–∞–∂–Ω—ã–µ - —Ä–∏—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏/—Ñ–∏–Ω–∞–Ω—Å–æ–≤)
6. **–ü—Ä–æ–±–ª–µ–º–∞ #7** - –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ upload-cover/extend
7. **–ü—Ä–æ–±–ª–µ–º–∞ #8** - Race condition –ø—Ä–∏ –¥–µ–±–µ—Ç–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
8. **–ü—Ä–æ–±–ª–µ–º–∞ #11** - –î—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è callback
9. **–ü—Ä–æ–±–ª–µ–º–∞ #2** - –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ cover vs extend (–ø–æ—Å–ª–µ #1-#6)

### üü° –ü–õ–ê–ù–û–í–û (–£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞)
10. **–ü—Ä–æ–±–ª–µ–º–∞ #9** - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ audioFile
11. **–ü—Ä–æ–±–ª–µ–º–∞ #10** - –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ DEFAULT_MODEL
12. **–ü—Ä–æ–±–ª–µ–º–∞ #12** - –ù–µ—Ç retry –ø—Ä–∏ download audio
13. **–ü—Ä–æ–±–ª–µ–º–∞ #16** - –ù–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è

### üí° –î–û–õ–ì–û–°–†–û–ß–ù–û (–î–∏–∑–∞–π–Ω –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
14. **–ü—Ä–æ–±–ª–µ–º–∞ #13** - –í—Å–µ —Ç—Ä–µ–∫–∏ –ø—É–±–ª–∏—á–Ω—ã–µ
15. **–ü—Ä–æ–±–ª–µ–º–∞ #14** - is_primary –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
16. **–ü—Ä–æ–±–ª–µ–º–∞ #15** - –°–º–µ—à–∏–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
17. **–ü—Ä–æ–±–ª–µ–º–∞ #17** - Timeout –¥–ª—è FileReader
18. **–ü—Ä–æ–±–ª–µ–º–∞ #18** - –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üõ†Ô∏è –ö–û–ù–ö–†–ï–¢–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1: useGenerateForm.ts

**–§–∞–π–ª:** `src/hooks/generation/useGenerateForm.ts`

**–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫—É 558:**
```typescript
// –î–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
defaultParamFlag: mode === 'custom',

// –ü–û–°–õ–ï (–ü–†–ê–í–ò–õ–¨–ù–û):
defaultParamFlag: mode !== 'custom',
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2: suno-upload-extend.ts

**–§–∞–π–ª:** `supabase/functions/suno-upload-extend/index.ts`

**–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫—É 177-210:**
```typescript
// –î–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
const requestBody: any = {
  uploadUrl: publicUrl,
  defaultParamFlag,
  model: apiModel,
  callBackUrl: `${supabaseUrl}/functions/v1/suno-music-callback`,
};

if (defaultParamFlag) {  // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  // Custom mode
  if (!style) {
    return new Response(
      JSON.stringify({ error: 'Style is required in custom mode' }),
      { status: 400 }
    );
  }

  requestBody.instrumental = instrumental;
  requestBody.style = style;
  // ...
}

// –ü–û–°–õ–ï (–ü–†–ê–í–ò–õ–¨–ù–û):
const requestBody: any = {
  uploadUrl: publicUrl,
  customMode: !defaultParamFlag,  // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º customMode, –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º defaultParamFlag
  model: apiModel,
  callBackUrl: `${supabaseUrl}/functions/v1/suno-music-callback`,
};

if (!defaultParamFlag) {  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  // Custom mode
  if (!style) {
    return new Response(
      JSON.stringify({ error: 'Style is required in custom mode' }),
      { status: 400 }
    );
  }

  requestBody.instrumental = instrumental;
  requestBody.style = style;
  // ...
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #3: audio.ts handler

**–§–∞–π–ª:** `supabase/functions/telegram-bot/handlers/audio.ts`

**–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 431-451:**
```typescript
// –î–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
const requestBody: Record<string, unknown> = {
  uploadUrl: publicUrl,
  model: apiModel,
  callBackUrl: `${supabaseUrl}/functions/v1/suno-music-callback`,
};

if (isExtend) {
  requestBody.defaultParamFlag = true;  // ‚ùå –í—Å–µ–≥–¥–∞ true!
  requestBody.instrumental = pendingUpload.instrumental || false;
  if (pendingUpload.style) requestBody.style = pendingUpload.style;
  if (pendingUpload.title) requestBody.title = pendingUpload.title;
  if (pendingUpload.prompt && !pendingUpload.instrumental) {
    requestBody.prompt = pendingUpload.prompt;
  }
} else {
  requestBody.customMode = Boolean(pendingUpload.style);  // ‚ùå –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å style!
  requestBody.instrumental = pendingUpload.instrumental || false;
  if (pendingUpload.style) requestBody.style = pendingUpload.style;
  if (pendingUpload.prompt) requestBody.prompt = pendingUpload.prompt;
  if (pendingUpload.title) requestBody.title = pendingUpload.title;
}

// –ü–û–°–õ–ï (–ü–†–ê–í–ò–õ–¨–ù–û):
const hasCustomParams = Boolean(
  pendingUpload.style ||
  pendingUpload.prompt ||
  pendingUpload.title
);

const requestBody: Record<string, unknown> = {
  uploadUrl: publicUrl,
  model: apiModel,
  callBackUrl: `${supabaseUrl}/functions/v1/suno-music-callback`,
  customMode: hasCustomParams,  // ‚úÖ –ï–¥–∏–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤
};

if (hasCustomParams) {
  requestBody.instrumental = pendingUpload.instrumental || false;
  if (pendingUpload.style) requestBody.style = pendingUpload.style;
  if (pendingUpload.title) requestBody.title = pendingUpload.title;
  if (pendingUpload.prompt && !pendingUpload.instrumental) {
    requestBody.prompt = pendingUpload.prompt;
  }
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #4: generate.ts

**–§–∞–π–ª:** `supabase/functions/telegram-bot/commands/generate.ts`

**–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 161-169:**
```typescript
// –î–û (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):
const { data, error: generateError } = await supabase.functions.invoke('suno-music-generate', {
  body: {
    mode,
    instrumental,
    model,
    prompt: actualPrompt,
    style: mode === 'custom' ? actualPrompt : undefined,  // ‚ùå prompt –∫–∞–∫ style!
  },
});

// –ü–û–°–õ–ï (–ü–†–ê–í–ò–õ–¨–ù–û):
const { data, error: generateError } = await supabase.functions.invoke('suno-music-generate', {
  body: {
    mode,
    instrumental,
    model,
    prompt: actualPrompt,
    // –î–ª—è custom mode style –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
    // –ü–æ–∫–∞ —á—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å actualPrompt, –Ω–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
    // –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–∫–∞–∑–∞—Ç—å style –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ --style
    style: mode === 'custom' ? (flags.style || actualPrompt) : undefined,
  },
});
```

**–ò –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–ª–∞–≥–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 99):**
```typescript
if (flags.instrumental) instrumental = true;
if (flags.mode) mode = flags.mode;
if (flags.model) model = flags.model.toUpperCase();
if (flags.style && mode === 'custom') {  // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ --style
  // style –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤–º–µ—Å—Ç–æ actualPrompt
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤

**–§–∞–π–ª—ã:**
- `supabase/functions/suno-upload-cover/index.ts`
- `supabase/functions/suno-upload-extend/index.ts`

**–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è userId (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 113):**
```typescript
userId = user.id;

// ‚úÖ –î–û–ë–ê–í–ò–¢–¨: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è non-admin –∏ non-telegram)
if (source !== 'telegram_bot') {
  const { data: isAdmin } = await supabase.rpc('has_role', {
    _user_id: userId,
    _role: 'admin'
  });

  if (!isAdmin) {
    const GENERATION_COST = 10;

    const { data: userCredits } = await supabase
      .from('user_credits')
      .select('balance')
      .eq('user_id', userId)
      .maybeSingle();

    const userBalance = userCredits?.balance ?? 0;

    if (userBalance < GENERATION_COST) {
      return new Response(
        JSON.stringify({
          error: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤. –ë–∞–ª–∞–Ω—Å: ${userBalance}, —Ç—Ä–µ–±—É–µ—Ç—Å—è: ${GENERATION_COST}`,
          errorCode: 'INSUFFICIENT_CREDITS',
        }),
        { status: 402, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }
  }
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #6: Race condition –ø—Ä–∏ –¥–µ–±–µ—Ç–µ

**–§–∞–π–ª:** `supabase/functions/suno-music-callback/index.ts`

**–°–æ–∑–¥–∞—Ç—å RPC —Ñ—É–Ω–∫—Ü–∏—é –≤ Supabase:**
```sql
CREATE OR REPLACE FUNCTION deduct_generation_credits(
  p_user_id UUID,
  p_cost INTEGER,
  p_description TEXT,
  p_metadata JSONB
)
RETURNS TABLE (new_balance INTEGER, success BOOLEAN)
LANGUAGE plpgsql
AS $$
DECLARE
  v_current_balance INTEGER;
  v_new_balance INTEGER;
BEGIN
  -- Lock row –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition
  SELECT balance INTO v_current_balance
  FROM user_credits
  WHERE user_id = p_user_id
  FOR UPDATE;

  -- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤
  IF v_current_balance < p_cost THEN
    RETURN QUERY SELECT v_current_balance, FALSE;
    RETURN;
  END IF;

  -- –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  UPDATE user_credits
  SET
    balance = balance - p_cost,
    total_spent = total_spent + p_cost,
    updated_at = NOW()
  WHERE user_id = p_user_id
  RETURNING balance INTO v_new_balance;

  -- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  INSERT INTO credit_transactions (
    user_id,
    amount,
    transaction_type,
    action_type,
    description,
    metadata
  ) VALUES (
    p_user_id,
    p_cost,
    'spend',
    'generation',
    p_description,
    p_metadata
  );

  RETURN QUERY SELECT v_new_balance, TRUE;
END;
$$;
```

**–ó–∞–º–µ–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 437-483 –≤ suno-music-callback.ts:**
```typescript
// –î–û: –í–µ—Å—å –±–ª–æ–∫ —Å SELECT –∏ UPDATE

// –ü–û–°–õ–ï:
if (!isAdmin) {
  const { data: deductResult, error: deductError } = await supabase
    .rpc('deduct_generation_credits', {
      p_user_id: task.user_id,
      p_cost: GENERATION_COST,
      p_description: `–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–∫–∞: ${clips[0]?.title || '–¢—Ä–µ–∫'}`,
      p_metadata: {
        trackId,
        clips: clips.length,
        model: task.model_used,
      },
    });

  if (deductError) {
    logger.error('Failed to deduct credits', deductError);
  } else if (deductResult && deductResult.length > 0) {
    const { new_balance, success } = deductResult[0];
    if (success) {
      logger.success('Credits deducted successfully', { newBalance: new_balance });
    } else {
      logger.warn('Insufficient credits for deduction', { balance: new_balance });
    }
  }
}
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º):

1. **Extend –æ—Ç audioFile –∏–∑ React app:**
   - Upload audioFile
   - –£–∫–∞–∑–∞—Ç—å custom style
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Suno API –ø–æ–ª—É—á–∞–µ—Ç customMode=true –∏ style

2. **Cover –æ—Ç audioFile –∏–∑ React app:**
   - Upload audioFile —Å —Ç–æ–ª—å–∫–æ prompt (–±–µ–∑ style)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Suno API –ø–æ–ª—É—á–∞–µ—Ç customMode=true –∏ prompt

3. **Extend –∏–∑ Telegram bot:**
   - /extend --style="rock" --title="Test"
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å audio
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

4. **Generate custom –∏–∑ Telegram bot:**
   - /generate —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ --mode=custom --style="jazz"
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ style != prompt

5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤:**
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å balance = 5
   - –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å generate (cost=10)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫—É 402

6. **Race condition test:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å 2 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å balance=15
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ balance = 0 (–Ω–µ -5!)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–±–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ failed –∏–ª–∏ –æ–¥–Ω–∞ failed

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –§—É–Ω–∫—Ü–∏—è **extend –ù–ï –†–ê–ë–û–¢–ê–ï–¢** –∏–∑-–∑–∞ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚ùå –§—É–Ω–∫—Ü–∏—è **cover –†–ê–ë–û–¢–ê–ï–¢ –ß–ê–°–¢–ò–ß–ù–û** (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω style)
- ‚ùå Telegram bot **–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ** (prompt=style)
- ‚ö†Ô∏è **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∏—Å–∫–∏** –∏–∑-–∑–∞ race condition –ø—Ä–∏ –¥–µ–±–µ—Ç–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
- ‚ö†Ô∏è **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏** –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ upload —Ñ—É–Ω–∫—Ü–∏—è—Ö

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –±—É–¥–µ—Ç –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

**–§–∞–∑–∞ 1 (1-2 –¥–Ω—è):** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è #1-#6 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏)
**–§–∞–∑–∞ 2 (2-3 –¥–Ω—è):** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è #7-#9 (–≤–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã)
**–§–∞–∑–∞ 3 (1 –Ω–µ–¥–µ–ª—è):** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è #10-#13 (—É–ª—É—á—à–µ–Ω–∏—è)
**–§–∞–∑–∞ 4 (–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ):** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è #14-#18 (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

### –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤:

–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∞—É–¥–∏—Ç—É –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** 2025-12-12
**–ê–≤—Ç–æ—Ä:** Claude Code AI Auditor
**–í–µ—Ä—Å–∏—è:** 1.0
