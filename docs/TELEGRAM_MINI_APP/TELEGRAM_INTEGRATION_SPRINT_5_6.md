# üöÄ Telegram Integration - Sprints 5-6

## Sprint 5: Native App Interface (grammY Migration)

**–¶–µ–ª—å**: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º grammY framework

**–î–∞—Ç—ã**: 2024-Q1 (4 –Ω–µ–¥–µ–ª–∏)

---

### 5.1 –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ grammY Framework

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ Critical

**–ó–∞–¥–∞—á–∏**:
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å grammY + plugins (`@grammyjs/menu`, `@grammyjs/runner`)
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∏–ø—ã –¥–ª—è `BotContext` —Å —Å–µ—Å—Å–∏—è–º–∏
- [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ handlers –Ω–∞ grammY API
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å middleware (auth, logging, error handling)
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏**:
```typescript
// supabase/functions/telegram-bot/core/types/bot.ts
import { Context, SessionFlavor } from "grammy";

export interface SessionData {
  currentTrackIndex: number;
  currentProjectIndex: number;
  lastMessageId?: number;
  view: 'main' | 'library' | 'projects' | 'settings';
}

export type BotContext = Context & SessionFlavor<SessionData>;
```

**Acceptence Criteria**:
- ‚úÖ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ grammY
- ‚úÖ –°–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- ‚úÖ –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç 80%+ –∫–æ–¥–∞

---

### 5.2 –†–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ Critical

**–ó–∞–¥–∞—á–∏**:
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `editMessageMedia` –¥–ª—è —Å–º–µ–Ω—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Å –æ–¥–Ω–∏–º –∞–∫—Ç–∏–≤–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (‚èÆÔ∏è/‚è≠Ô∏è)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å fallback –Ω–∞ `replyWithPhoto` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–ö–æ–¥**:
```typescript
// handlers/navigation.ts
async function renderTrack(ctx: BotContext, index: number) {
  const tracks = await musicService.getTracks(ctx.from!.id);
  const track = tracks[index];

  try {
    await ctx.editMessageMedia({
      type: "photo",
      media: track.coverUrl,
      caption: formatTrackCaption(track, index, tracks.length)
    }, { 
      reply_markup: createPlayerControls(track.id, index, tracks.length) 
    });
  } catch (error) {
    // Fallback: –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await ctx.replyWithPhoto(track.coverUrl, {
      caption: formatTrackCaption(track, index, tracks.length),
      reply_markup: createPlayerControls(track.id, index, tracks.length)
    });
  }
}
```

**Acceptence Criteria**:
- ‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ç—Ä–µ–∫–∞–º–∏ –±–µ–∑ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ü–ª–∞–≤–Ω–∞—è —Å–º–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ (< 500ms)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

---

### 5.3 –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–ª–µ–µ—Ä

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° High

**–ó–∞–¥–∞—á–∏**:
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏: ‚ù§Ô∏è (like), ‚¨áÔ∏è (download), ‚úÇÔ∏è (stems)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∞—É–¥–∏–æ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (`sendAudio`)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –æ–±–ª–æ–∂–∫–∏ –≤ –ø–ª–µ–µ—Ä–µ Telegram
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ç–µ–≥–∏ —Ç—Ä–µ–∫–∞

**–ú–∞–∫–µ—Ç –∫–Ω–æ–ø–æ–∫**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [–û–±–ª–æ–∂–∫–∞ —Ç—Ä–µ–∫–∞]            ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  üéß Sunset Dreams           ‚îÇ
‚îÇ  üë§ AI Artist               ‚îÇ
‚îÇ  üè∑ #Pop #Chill             ‚îÇ
‚îÇ  üíø –¢—Ä–µ–∫ 1 –∏–∑ 5             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [‚èÆÔ∏è] [ ‚ñ∂Ô∏è PLAY ] [‚è≠Ô∏è]      ‚îÇ
‚îÇ  [‚ù§Ô∏è Like] [‚¨áÔ∏è] [‚úÇÔ∏è Stems]  ‚îÇ
‚îÇ  [üîô –ù–∞–∑–∞–¥]                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Acceptence Criteria**:
- ‚úÖ –ê—É–¥–∏–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ –Ω–∞—Ç–∏–≤–Ω–æ–º –ø–ª–µ–µ—Ä–µ
- ‚úÖ –û–±–ª–æ–∂–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í—Å–µ –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

### 5.4 –≠–∫—Ä–∞–Ω "–ü—Ä–æ–µ–∫—Ç—ã"

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° High

**–ó–∞–¥–∞—á–∏**:
- [ ] –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è `/projects`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é –ø—Ä–æ–µ–∫—Ç–æ–≤ (‚¨ÖÔ∏è/‚û°Ô∏è)
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±–ª–æ–∂–∫—É –∞–ª—å–±–æ–º–∞ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –≤ Studio" (WebApp)

**–ú–∞–∫–µ—Ç**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞]          ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  üìÅ My Summer EP            ‚îÇ
‚îÇ  5 —Ç—Ä–µ–∫–æ–≤ ‚Ä¢ 15 –º–∏–Ω—É—Ç        ‚îÇ
‚îÇ  –°–æ–∑–¥–∞–Ω: 12.12.2024         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [‚¨ÖÔ∏è] [–ü—Ä–æ–µ–∫—Ç 1/3] [‚û°Ô∏è]     ‚îÇ
‚îÇ  [üìÇ –û—Ç–∫—Ä—ã—Ç—å –≤ Studio]      ‚îÇ
‚îÇ  [üîô –ù–∞–∑–∞–¥]                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Acceptence Criteria**:
- ‚úÖ –°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î
- ‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –ø—Ä–æ–µ–∫—Ç–∞–º–∏
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å" –∑–∞–ø—É—Å–∫–∞–µ—Ç Mini App

---

### 5.5 –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ Critical

**–ó–∞–¥–∞—á–∏**:
- [ ] –°–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π –±–∞–Ω–Ω–µ—Ä –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "üöÄ OPEN STUDIO" (WebApp)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏: üéπ –ü—Ä–æ–µ–∫—Ç—ã, üéß –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞, ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª "‚ÑπÔ∏è –û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ"

**–ö–æ–¥ –º–µ–Ω—é**:
```typescript
// menus/main-menu.ts
export const createMainMenuKeyboard = () => {
  return new InlineKeyboard()
    .webApp("üöÄ OPEN STUDIO", { url: MINI_APP_URL }).row()
    .text("üéπ –ü—Ä–æ–µ–∫—Ç—ã", "nav_projects")
    .text("üéß –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞", "nav_library").row()
    .text("‚ÑπÔ∏è –û –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ", "nav_about")
    .text("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "nav_settings");
};
```

**Acceptence Criteria**:
- ‚úÖ –í—Å–µ –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ WebApp –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é –∏–∑ –ª—é–±–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞

---

## Sprint 6: Advanced Features

**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —à–∞—Ä–∏–Ω–≥–∞, inline-—Ä–µ–∂–∏–º–∞ –∏ AI-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**–î–∞—Ç—ã**: 2024-Q1 (3 –Ω–µ–¥–µ–ª–∏)

---

### 6.1 Inline Mode (–ü–æ–ª–Ω—ã–π)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° High

**–ó–∞–¥–∞—á–∏**:
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `bot.on('inline_query')` handler
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∏—Å–∫ —Ç—Ä–µ–∫–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/—Ç–µ–≥–∞–º
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–≤—å—é –æ–±–ª–æ–∂–µ–∫ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–∫" –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:
```
@MusicVerseBot sunset chill
‚Üí –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ —Å —Ç–µ–≥–∞–º–∏ "sunset" –∏ "chill"
‚Üí –ü—Ä–∏ –∫–ª–∏–∫–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ –≤ —á–∞—Ç
```

**–ö–æ–¥**:
```typescript
// handlers/inline.ts
bot.on("inline_query", async (ctx) => {
  const query = ctx.inlineQuery.query.toLowerCase();
  const tracks = await searchTracks(query);

  const results = tracks.map((track, i) => ({
    type: "audio" as const,
    id: track.id,
    audio_url: track.audioUrl,
    title: track.title,
    performer: track.artist,
    thumbnail_url: track.coverUrl,
    reply_markup: {
      inline_keyboard: [[
        { text: "üéµ –û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–∫", url: `${BOT_URL}?start=track_${track.id}` }
      ]]
    }
  }));

  await ctx.answerInlineQuery(results, {
    cache_time: 300,
    is_personal: true
  });
});
```

**Acceptence Criteria**:
- ‚úÖ –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º —á–∞—Ç–µ
- ‚úÖ –ê—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ö–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

---

### 6.2 Share Menu

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ Medium

**–ó–∞–¥–∞—á–∏**:
- [ ] –°–æ–∑–¥–∞—Ç—å –º–µ–Ω—é —à–∞—Ä–∏–Ω–≥–∞ (chat, friends, story, link)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `switch_inline_query` –¥–ª—è –¥—Ä—É–∑–µ–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "Share to Story" (Telegram Stories API)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É"

**–ú–∞–∫–µ—Ç –º–µ–Ω—é**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ç—Ä–µ–∫–æ–º       ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  üéµ Sunset Dreams           ‚îÇ
‚îÇ  üé∏ Pop                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç]       ‚îÇ
‚îÇ  [üë• –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏] ‚îÇ ‚Üê switch_inline_query
‚îÇ  [üìñ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ Stories]  ‚îÇ
‚îÇ  [üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É]     ‚îÇ
‚îÇ  [üîô –ù–∞–∑–∞–¥ –∫ —Ç—Ä–µ–∫—É]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ö–æ–¥**:
```typescript
// menus/share-menu.ts
export const createShareMenu = (trackId: string) => {
  return new InlineKeyboard()
    .text("üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç", `share_chat_${trackId}`).row()
    .switchInline("üë• –° –¥—Ä—É–∑—å—è–º–∏", `track_${trackId}`).row()
    .text("üìñ –í Stories", `share_story_${trackId}`).row()
    .text("üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", `share_link_${trackId}`).row()
    .text("üîô –ù–∞–∑–∞–¥", `track_${trackId}`);
};
```

**Acceptence Criteria**:
- ‚úÖ –í—Å–µ —Å–ø–æ—Å–æ–±—ã —à–∞—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –°—Å—ã–ª–∫–∞ –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –±—É—Ñ–µ—Ä
- ‚úÖ Stories API –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω

---

### 6.3 Emoji Status

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ Medium

**–ó–∞–¥–∞—á–∏**:
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Emoji Status API
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "üéµ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –≤ —Å—Ç–∞—Ç—É—Å–µ (–≤—Ä–µ–º–µ–Ω–Ω–æ)
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ N –º–∏–Ω—É—Ç

**–ü—Ä–∏–º–µ—Ä**:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ª—É—à–∞–µ—Ç "Sunset Dreams" 
‚Üí –°—Ç–∞—Ç—É—Å: üéµ –°–ª—É—à–∞—é AI-—Ç—Ä–µ–∫ (1 —á–∞—Å)
‚Üí –ü–æ—Å–ª–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å —É–¥–∞–ª—è–µ—Ç—Å—è
```

**Acceptence Criteria**:
- ‚úÖ –°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
- ‚úÖ –ö—Ä–∞—Å–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —ç–º–æ–¥–∑–∏

---

### 6.4 AI Lyrics Assistant

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü¢ Medium

**–ó–∞–¥–∞—á–∏**:
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/lyrics <—Ç–µ–º–∞>`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GPT/Gemini —á–µ—Ä–µ–∑ Supabase AI
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É
- [ ] –ö–Ω–æ–ø–∫–∞ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç—Ä–µ–∫–∞"

**–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞**:
```
User: /lyrics love and summer
Bot: 
üé§ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ª–∏—Ä–∏–∫—É...

üìù Generated Lyrics:
[Verse 1]
Summer breeze, warm embrace
Your smile lights up this place
...

[Chorus]
Love like summer, never ends
...

[‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å] [üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å]
```

**Acceptence Criteria**:
- ‚úÖ –õ–∏—Ä–∏–∫–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è < 5 —Å–µ–∫
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (Verse/Chorus) –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è
- ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `/generate`

---

### 6.5 Stems UI

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üü° High

**–ó–∞–¥–∞—á–∏**:
- [ ] –°–æ–∑–¥–∞—Ç—å —ç–∫—Ä–∞–Ω "–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞"
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–µ–º–æ–≤
- [ ] –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å ZIP —Å —Ñ–∞–π–ª–∞–º–∏ (vocals, drums, bass, other)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–≤—å—é —Å—Ç–µ–º–æ–≤ (waveform)

**–ú–∞–∫–µ—Ç**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÇÔ∏è –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞        ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  üéµ Sunset Dreams           ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  ‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–µ–º–æ–≤...     ‚îÇ
‚îÇ  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë  75%     ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  ‚úÖ Vocals (–≥–æ—Ç–æ–≤–æ)         ‚îÇ
‚îÇ  ‚úÖ Drums (–≥–æ—Ç–æ–≤–æ)          ‚îÇ
‚îÇ  ‚è≥ Bass (–æ–±—Ä–∞–±–æ—Ç–∫–∞...)     ‚îÇ
‚îÇ  ‚è∏Ô∏è Other (–≤ –æ—á–µ—Ä–µ–¥–∏)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [üì• –°–∫–∞—á–∞—Ç—å –≤—Å–µ (ZIP)]     ‚îÇ
‚îÇ  [üîô –ö —Ç—Ä–µ–∫—É]               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Acceptence Criteria**:
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- ‚úÖ ZIP —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- ‚úÖ –ú–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç–µ–º—ã

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### Performance
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞: < 500ms (90 percentile)
- –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞: < 2 —Å–µ–∫—É–Ω–¥—ã
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞: 100+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### Security
- JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- RLS policies –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
- Rate limiting: 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –í–∞–ª–∏–¥–∞—Ü–∏—è `initData` —á–µ—Ä–µ–∑ HMAC

### Monitoring
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (Supabase Logs)
- –ú–µ—Ç—Ä–∏–∫–∏: DAU, MAU, —Ç—Ä–µ–∫–∏ –≤ –¥–µ–Ω—å
- Alerts: –æ—à–∏–±–∫–∏ > 5% –∑–∞ 5 –º–∏–Ω—É—Ç

---

## Testing Plan

### Unit Tests
```typescript
describe('Navigation Handler', () => {
  it('should render track on lib_page callback', async () => {
    const ctx = mockContext({ match: ['lib_page_2', '2'] });
    await navigationHandler.middleware()(ctx, jest.fn());
    expect(ctx.editMessageMedia).toHaveBeenCalled();
  });
});
```

### Integration Tests
- –ü–æ–ª–Ω—ã–π flow: /start ‚Üí library ‚Üí play ‚Üí back
- Deep linking: `t.me/bot?start=track_123`
- Inline —Ä–µ–∂–∏–º: –ø–æ–∏—Å–∫ ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞

### E2E Tests (Playwright)
```typescript
test('User can navigate library', async ({ page }) => {
  await page.goto('https://web.telegram.org');
  await page.click('[data-testid="bot-menu"]');
  await page.click('text=–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞');
  await page.click('[data-testid="next-track"]');
  expect(await page.textContent('.track-title')).toBe('Track 2');
});
```

---

## Rollout Plan

### Phase 1: Alpha (10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∫–æ–º–∞–Ω–¥–∞ + –¥—Ä—É–∑—å—è
- –°–±–æ—Ä –±–∞–≥–æ–≤ –∏ —Ñ–∏–¥–±–µ–∫–∞

### Phase 2: Beta (100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ UI

### Phase 3: Public Launch
- –û—Ç–∫—Ä—ã—Ç—ã–π –¥–æ—Å—Ç—É–ø
- –ü—Ä–µ—Å—Å-—Ä–µ–ª–∏–∑
- –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è

---

## Risks & Mitigation

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|-----------|
| –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Suno API | –°—Ä–µ–¥–Ω—è—è | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ + rate limiting |
| –û—à–∏–±–∫–∏ `editMessageMedia` | –í—ã—Å–æ–∫–∞—è | Fallback –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (stems) | –°—Ä–µ–¥–Ω—è—è | –ö–æ–º–ø—Ä–µ—Å—Å–∏—è + CDN |
| –°–ø–∞–º-–∞—Ç–∞–∫–∏ | –ù–∏–∑–∫–∞—è | Rate limiting + CAPTCHA |

---

## Success Metrics

### Sprint 5
- ‚úÖ 100% –∫–æ–º–∞–Ω–¥ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ grammY
- ‚úÖ < 500ms –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ (p90)
- ‚úÖ 0 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–≥–æ–≤

### Sprint 6
- ‚úÖ Inline —Ä–µ–∂–∏–º –∏—Å–ø–æ–ª—å–∑—É—é—Ç 30%+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ Share menu: 50+ —à–∞—Ä–∏–Ω–≥–æ–≤/–¥–µ–Ω—å
- ‚úÖ AI Lyrics: 20+ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π/–¥–µ–Ω—å

---

**–ê–≤—Ç–æ—Ä**: MusicVerse Team  
**–î–∞—Ç–∞**: 2024  
**–í–µ—Ä—Å–∏—è**: 2.0
