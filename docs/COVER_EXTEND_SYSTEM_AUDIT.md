# –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç —Å–∏—Å—Ç–µ–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–≤–µ—Ä–æ–≤ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤

## –î–∞—Ç–∞: 2025-12-12
## –í–µ—Ä—Å–∏—è: 1.0

---

## üéØ –¶–µ–ª—å –∞—É–¥–∏—Ç–∞

–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç—â–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (Mini App –∏ Bot) –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π:
- **Upload & Cover Audio** (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–≤–µ—Ä–∞)
- **Upload & Extend Audio** (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ/—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞)

–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏ –∏—Ö –ª–∏–º–∏—Ç—ã –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞—É–¥–∏–æ.

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

1. **–ü–∞—Ä–∞–º–µ—Ç—Ä customMode**
   - ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –¥–ª—è –æ–±–æ–∏—Ö endpoint (cover –∏ extend)
   - ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ edge functions
   - ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ UI

2. **Model mapping**
   - ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ UI –º–æ–¥–µ–ª–∏ —Å API –º–æ–¥–µ–ª—å—é
   - ‚úÖ –§—É–Ω–∫—Ü–∏—è `getApiModelName()` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç V4_5ALL ‚Üí V4_5
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ VALID_MODELS

3. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**
   - ‚úÖ JWT –¥–ª—è Web App
   - ‚úÖ Bot secret –¥–ª—è Telegram Bot
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ user_id –≤ –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö

4. **Credit checking**
   - ‚úÖ –ü—Ä–æ–ø—É—Å–∫ –¥–ª—è admin –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - ‚úÖ –ü—Ä–æ–ø—É—Å–∫ –¥–ª—è telegram_bot –∏—Å—Ç–æ—á–Ω–∏–∫–∞
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. **–ö–†–ò–¢–ò–ß–ù–û: –õ–∏–º–∏—Ç—ã –º–æ–¥–µ–ª–µ–π –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—á—Ç–µ–Ω—ã**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `UploadAudioDialog.tsx` –µ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è V4_5ALL (60 —Å–µ–∫) –∏ –æ–±—â–∞—è (480 —Å–µ–∫), –Ω–æ:

```typescript
// –¢–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞ (–ù–ï–ü–û–õ–ù–ê–Ø):
if (model === 'V4_5ALL' && audioDuration && audioDuration > 60) {
  toast.error('–î–ª—è –º–æ–¥–µ–ª–∏ V4.5 All –∞—É–¥–∏–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 1 –º–∏–Ω—É—Ç—É');
  return;
}

if (audioDuration && audioDuration > 480) {
  toast.error('–ê—É–¥–∏–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 8 –º–∏–Ω—É—Ç');
  return;
}
```

**–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ª–∏–º–∏—Ç—ã –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ SunoAPI:**

| –ú–æ–¥–µ–ª—å | API Name | –ú–∞–∫—Å. –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|--------|----------|-------------------|------------|
| V5 | chirp-crow | 480 —Å–µ–∫ (8 –º–∏–Ω) | –ü–æ—Å–ª–µ–¥–Ω—è—è –º–æ–¥–µ–ª—å |
| V4_5PLUS | chirp-bluejay | 480 —Å–µ–∫ (8 –º–∏–Ω) | –ë–æ–≥–∞—Ç—ã–π –∑–≤—É–∫ |
| V4_5ALL | chirp-auk | 60 —Å–µ–∫ (1 –º–∏–Ω) | ‚ö†Ô∏è –û–°–û–ë–´–ô –õ–ò–ú–ò–¢ |
| V4 | chirp-v4 | 240 —Å–µ–∫ (4 –º–∏–Ω) | ‚ö†Ô∏è –°–†–ï–î–ù–ò–ô –õ–ò–ú–ò–¢ |

**–ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- ‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è V4 (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 240 —Å–µ–∫, –Ω–µ 480)
- ‚ùå –Ø–≤–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è V5 –∏ V4_5PLUS
- ‚ùå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö –≤ UI –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```typescript
const MODEL_DURATION_LIMITS: Record<string, number> = {
  'V5': 480,
  'V4_5PLUS': 480,
  'V4_5ALL': 60,
  'V4': 240,
};

const getModelDurationLimit = (modelKey: string): number => {
  return MODEL_DURATION_LIMITS[modelKey] || 480;
};

// –í –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
const maxDuration = getModelDurationLimit(model);
if (audioDuration && audioDuration > maxDuration) {
  const minutes = Math.floor(maxDuration / 60);
  const seconds = maxDuration % 60;
  const timeStr = seconds > 0 ? `${minutes} –º–∏–Ω ${seconds} —Å–µ–∫` : `${minutes} –º–∏–Ω`;
  toast.error(`–î–ª—è –º–æ–¥–µ–ª–∏ ${SUNO_MODELS[model]?.name || model} –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${timeStr}`);
  return;
}
```

#### 2. **–ö–†–ò–¢–ò–ß–ù–û: Edge functions –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ª–∏–º–∏—Ç—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `suno-upload-cover/index.ts` –∏ `suno-upload-extend/index.ts` –ù–ï–¢ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞—É–¥–∏–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ SunoAPI.

**–†–∏—Å–∫:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–æ–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é
- –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –≤ SunoAPI –∏ –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É
- –ü–æ—Ç–µ—Ä—è –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü–ª–æ—Ö–æ–π UX

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤ edge functions:

```typescript
// –í suno-upload-cover/index.ts –∏ suno-upload-extend/index.ts

const MODEL_DURATION_LIMITS: Record<string, number> = {
  'V5': 480,
  'V4_5PLUS': 480,
  'V4_5': 60,  // V4_5ALL –º–∞–ø–∏—Ç—Å—è –Ω–∞ V4_5
  'V4': 240,
  'V3_5': 180,
};

// –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è publicUrl, –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
// (–¢—Ä–µ–±—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)
```

#### 3. **–ù–µ–ø–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –ª–∏–º–∏—Ç—ã –º–æ–¥–µ–ª–∏ –î–û –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ.

**–¢–µ–∫—É—â–µ–µ:** –õ–∏–º–∏—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ (—Ñ—É–Ω–∫—Ü–∏—è `getMaxDuration()`).

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏–º–∏—Ç—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–æ–¥–µ–ª–∏
- –ü–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ê–≤—Ç–æ–≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –µ—Å–ª–∏ —Ñ–∞–π–ª –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç

#### 4. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤ Bot**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ inline keyboard, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ü–û–í–¢–û–†–ù–û –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª.

**–¢–µ–∫—É—â–∏–π —Ñ–ª–æ—É:**
```
1. User sends audio
2. Bot stores file_id (5 min TTL)
3. Bot shows inline keyboard
4. User clicks action
5. Bot asks: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ" ‚ùå
6. User resends audio
7. Process starts
```

**–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–ª–æ—É:**
```
1. User sends audio
2. Bot stores file_id (5 min TTL)
3. Bot shows inline keyboard
4. User clicks action
5. Bot automatically processes stored file_id ‚úÖ
6. Process starts (no resend needed)
```

**–§–∞–π–ª:** `supabase/functions/telegram-bot/commands/audio-upload.ts`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
export async function handleAudioActionCallback(...) {
  // Get stored audio
  const audioData = await consumePendingAudio(userId);
  
  // Set mode
  await setPendingUpload(userId, 'cover', {});
  
  // Ask to resend ‚ùå
  await editMessageText(chatId, messageId, 
    `‚úÖ *–†–µ–∂–∏–º –≤—ã–±—Ä–∞–Ω: –ö–∞–≤–µ—Ä*\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏\\.`);
}
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```typescript
export async function handleAudioActionCallback(...) {
  // Get stored audio
  const audioData = await consumePendingAudio(userId);
  
  if (!audioData) {
    await answerCallbackQuery(callbackId, '‚ö†Ô∏è –ê—É–¥–∏–æ —Ñ–∞–π–ª –∏—Å—Ç—ë–∫. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–Ω–æ–≤–∞.');
    return;
  }
  
  // Download file from Telegram immediately
  const fileUrl = await getFileUrl(audioData.fileId);
  const audioBlob = await fetch(fileUrl).then(r => r.blob());
  
  // Process immediately
  await processAudioUpload(userId, action, audioBlob, chatId);
}
```

---

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (User Flow)

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Web App - Cover Generation

```
–®–∞–≥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç GenerateSheet
‚îÇ
‚îú‚îÄ‚ñ∂ –ù–∞–∂–∏–º–∞–µ—Ç "Audio" button
‚îÇ   ‚îî‚îÄ‚ñ∂ –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è AudioUploadActionDialog
‚îÇ
–®–∞–≥ 2: Upload –∏–ª–∏ Record audio
‚îÇ   ‚îú‚îÄ‚ñ∂ Upload: File input (max 20MB) ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Record: MediaRecorder API ‚úÖ
‚îÇ       ‚îî‚îÄ‚ñ∂ Shows waveform preview ‚úÖ
‚îÇ
–®–∞–≥ 3: –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
‚îÇ   ‚îú‚îÄ‚ñ∂ [üéµ –°–æ–∑–¥–∞—Ç—å –∫–∞–≤–µ—Ä] ‚úÖ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚ñ∂ –û–ø–∏—Å–∞–Ω–∏–µ: "–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å –¥—Ä—É–≥–∏–º —Å—Ç–∏–ª–µ–º, —Å–æ—Ö—Ä–∞–Ω—è—è –º–µ–ª–æ–¥–∏—é"
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚ñ∂ [‚ûï –†–∞—Å—à–∏—Ä–∏—Ç—å —Ç—Ä–µ–∫]
‚îÇ       ‚îî‚îÄ‚ñ∂ –û–ø–∏—Å–∞–Ω–∏–µ: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ —Ç—Ä–µ–∫, –¥–æ–±–∞–≤–∏–≤ –Ω–æ–≤—É—é —á–∞—Å—Ç—å"
‚îÇ
–®–∞–≥ 4: UploadAudioDialog –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å mode='cover'
‚îÇ
–®–∞–≥ 5: –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚ñ∂ V5 (8 –º–∏–Ω) ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –ª–∏–º–∏—Ç–∞ –î–û –≤—ã–±–æ—Ä–∞
‚îÇ   ‚îú‚îÄ‚ñ∂ V4.5+ (8 –º–∏–Ω)
‚îÇ   ‚îú‚îÄ‚ñ∂ V4.5 All (1 –º–∏–Ω) ‚ö†Ô∏è –û—Å–æ–±—ã–π –ª–∏–º–∏—Ç
‚îÇ   ‚îî‚îÄ‚ñ∂ V4 (4 –º–∏–Ω) ‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π –ª–∏–º–∏—Ç
‚îÇ
–®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚ñ∂ Custom Mode / Simple Mode ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Style (required if customMode) ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Lyrics (optional) ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Instrumental switch ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Advanced settings (negativeTags, weights) ‚úÖ
‚îÇ
–®–∞–≥ 7: –í–∞–ª–∏–¥–∞—Ü–∏—è –ü–ï–†–ï–î –æ—Ç–ø—Ä–∞–≤–∫–æ–π
‚îÇ   ‚îú‚îÄ‚ñ∂ ‚úÖ File exists
‚îÇ   ‚îú‚îÄ‚ñ∂ ‚úÖ Style if customMode
‚îÇ   ‚îú‚îÄ‚ñ∂ ‚úÖ Prompt if !customMode
‚îÇ   ‚îú‚îÄ‚ñ∂ ‚ö†Ô∏è Duration for V4_5ALL (60s)
‚îÇ   ‚îú‚îÄ‚ñ∂ ‚ùå Duration for V4 (240s) - –ù–ï –ü–†–û–í–ï–†–Ø–ï–¢–°–Ø
‚îÇ   ‚îî‚îÄ‚ñ∂ ‚úÖ Duration general (480s)
‚îÇ
–®–∞–≥ 8: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ edge function
‚îÇ   ‚îú‚îÄ‚ñ∂ Convert to base64 ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Call suno-upload-cover ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Parameters: customMode, style, prompt, model ‚úÖ
‚îÇ
–®–∞–≥ 9: Edge function processing
‚îÇ   ‚îú‚îÄ‚ñ∂ Auth validation ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Credit check (if not admin/bot) ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Upload to Supabase Storage ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ ‚ùå NO duration validation
‚îÇ   ‚îú‚îÄ‚ñ∂ Call SunoAPI ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Create generation_tasks + tracks ‚úÖ
‚îÇ
–®–∞–≥ 10: User feedback
‚îÇ   ‚îú‚îÄ‚ñ∂ Toast: "–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–≤–µ—Ä–∞ –Ω–∞—á–∞–ª–æ—Å—å!" ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Track –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Callback updates status ‚úÖ
```

**–ü—Ä–æ–±–ª–µ–º—ã –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö –º–æ–¥–µ–ª–∏
2. ‚ùå –ù–µ–ø–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (V4)
3. ‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
4. ‚ö†Ô∏è –ù–µ—Ç –∞–≤—Ç–æ–≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –µ—Å–ª–∏ —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Web App - Extend Generation

–ê–Ω–∞–ª–æ–≥–∏—á–µ–Ω –°—Ü–µ–Ω–∞—Ä–∏—é 1, –Ω–æ:
- Mode = 'extend'
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: `continueAt` (—Å–µ–∫—É–Ω–¥—ã) ‚úÖ
- –ü–∞—Ä–∞–º–µ—Ç—Ä `customMode` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ (–±—ã–ª bug —Å `defaultParamFlag`, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω)

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Telegram Bot - Cover (—Å –∫–æ–º–∞–Ω–¥–æ–π)

```
–®–∞–≥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /cover
‚îÇ   ‚îî‚îÄ‚ñ∂ –û–ø—Ü–∏–∏: --style="indie rock" --instrumental ‚úÖ
‚îÇ
–®–∞–≥ 2: Bot —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç pending_upload
‚îÇ   ‚îú‚îÄ‚ñ∂ Mode: 'cover' ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Options: {style, instrumental} ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ TTL: 15 –º–∏–Ω—É—Ç ‚úÖ
‚îÇ
–®–∞–≥ 3: Bot –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚ñ∂ "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª..." ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Inline keyboard: [–û—Ç–º–µ–Ω–∞] ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Deep link to Mini App ‚úÖ
‚îÇ
–®–∞–≥ 4: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç audio
‚îÇ   ‚îú‚îÄ‚ñ∂ File type: audio, voice, or document ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Size validation: 25MB (Telegram limit) ‚úÖ
‚îÇ
–®–∞–≥ 5: Bot handler processes
‚îÇ   ‚îú‚îÄ‚ñ∂ Checks pending_upload ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Downloads from Telegram ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Converts to base64 ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ ‚ùå NO duration validation
‚îÇ   ‚îú‚îÄ‚ñ∂ Uploads to Supabase Storage ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Calls suno-upload-cover via processAudioUpload() ‚úÖ
‚îÇ
–®–∞–≥ 6: Edge function processes (same as Web App)
‚îÇ
–®–∞–≥ 7: Bot notification
‚îÇ   ‚îú‚îÄ‚ñ∂ "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–≤–µ—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!" ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Task ID ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Inline keyboard: [–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏] ‚úÖ
```

**–ü—Ä–æ–±–ª–µ–º—ã –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. ‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ bot handler
2. ‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö –º–æ–¥–µ–ª–∏
3. ‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ bot (–≤—Å–µ–≥–¥–∞ V4_5ALL)

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: Telegram Bot - Cover/Extend (–±–µ–∑ –∫–æ–º–∞–Ω–¥—ã, NEW)

```
–®–∞–≥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç audio
‚îÇ   ‚îî‚îÄ‚ñ∂ –ë–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã
‚îÇ
–®–∞–≥ 2: Bot stores file_id
‚îÇ   ‚îú‚îÄ‚ñ∂ Sets pending_audio ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ TTL: 5 –º–∏–Ω—É—Ç ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ Table: telegram_bot_sessions ‚úÖ
‚îÇ
–®–∞–≥ 3: Bot shows inline keyboard
‚îÇ   ‚îú‚îÄ‚ñ∂ [üé§ –°–æ–∑–¥–∞—Ç—å –∫–∞–≤–µ—Ä] ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ [‚ûï –†–∞—Å—à–∏—Ä–∏—Ç—å —Ç—Ä–µ–∫] ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ [üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ] ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ [üéº –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ø–µ—Å–Ω—é] ‚è≥ Coming soon
‚îÇ   ‚îî‚îÄ‚ñ∂ [üéπ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ MIDI] ‚è≥ Coming soon
‚îÇ
–®–∞–≥ 4: User clicks action button
‚îÇ   ‚îî‚îÄ‚ñ∂ Callback: audio_action_cover ‚úÖ
‚îÇ
–®–∞–≥ 5: Bot handler (handleAudioActionCallback)
‚îÇ   ‚îú‚îÄ‚ñ∂ Consumes pending_audio ‚úÖ
‚îÇ   ‚îú‚îÄ‚ñ∂ Sets pending_upload mode ‚úÖ
‚îÇ   ‚îî‚îÄ‚ñ∂ ‚ùå Asks user to RESEND audio (–Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ!)
‚îÇ
–®–∞–≥ 6: User resends audio ‚ùå
‚îÇ   ‚îî‚îÄ‚ñ∂ Same as Scenario 3, –®–∞–≥ 4-7
```

**–ü—Ä–æ–±–ª–µ–º—ã –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. ‚ùå **–ö–†–ò–¢–ò–ß–ù–û:** –¢—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
2. ‚ö†Ô∏è Stored file_id –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–æ–±—Ä–∞–±–æ—Ç–∫–∏
3. ‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
4. ‚ùå –ù–µ—Ç –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏

---

## üé® –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

### Mini App Interface

#### AudioUploadActionDialog (NEW) ‚úÖ

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–π –¥–≤—É—Ö—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
- ‚úÖ Audio preview —Å play/pause
- ‚úÖ Clean –Ω–∞–≤–∏–≥–∞—Ü–∏—è (Back button)

**–ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:**
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö –º–æ–¥–µ–ª–µ–π
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
- ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤

#### UploadAudioDialog

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ Tabs –¥–ª—è –≤—ã–±–æ—Ä–∞ mode (Cover / Extend)
- ‚úÖ Custom/Simple mode toggle
- ‚úÖ Advanced settings collapsible
- ‚úÖ Model selector
- ‚úÖ Library integration (–≤—ã–±–æ—Ä –∏–∑ —Ç—Ä–µ–∫–æ–≤)

**–ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:**
- ‚ùå **–ö–†–ò–¢–ò–ß–ù–û:** –ù–µ—Ç –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏
- ‚ùå **–ö–†–ò–¢–ò–ß–ù–û:** –í–∞–ª–∏–¥–∞—Ü–∏—è V4 –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- ‚ö†Ô∏è getMaxDuration() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–∏
- ‚ö†Ô∏è –ù–µ—Ç –∞–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∏ –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π UI:**

```tsx
<Select value={model} onValueChange={setModel}>
  <SelectTrigger>
    <SelectValue />
  </SelectTrigger>
  <SelectContent>
    {getAvailableModels().map(m => (
      <SelectItem key={m.key} value={m.key}>
        <div className="flex items-center justify-between w-full">
          <span>{m.emoji} {m.name}</span>
          <Badge variant={audioDuration && audioDuration <= getModelDurationLimit(m.key) ? "default" : "destructive"}>
            –º–∞–∫—Å. {Math.floor(getModelDurationLimit(m.key) / 60)} –º–∏–Ω
          </Badge>
        </div>
        <div className="text-xs text-muted-foreground">{m.desc}</div>
      </SelectItem>
    ))}
  </SelectContent>
</Select>

{/* Warning if audio exceeds model limit */}
{audioDuration && audioDuration > getModelDurationLimit(model) && (
  <Alert variant="destructive">
    <AlertCircle className="h-4 w-4" />
    <AlertDescription>
      –í–∞—à–µ –∞—É–¥–∏–æ ({Math.floor(audioDuration / 60)} –º–∏–Ω {Math.floor(audioDuration % 60)} —Å–µ–∫) 
      –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –º–æ–¥–µ–ª–∏ {SUNO_MODELS[model]?.name} 
      ({Math.floor(getModelDurationLimit(model) / 60)} –º–∏–Ω). 
      –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å.
    </AlertDescription>
  </Alert>
)}

{/* Suggested model */}
{audioDuration && audioDuration > getModelDurationLimit(model) && (
  <Button 
    variant="outline" 
    size="sm"
    onClick={() => setModel(suggestModelForDuration(audioDuration))}
  >
    –í—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â—É—é –º–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  </Button>
)}
```

### Telegram Bot Interface

#### Command-first flow (/cover, /extend) ‚úÖ

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ–º–∞–Ω–¥
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ flags (--style, --instrumental)
- ‚úÖ Inline keyboard –¥–ª—è –æ—Ç–º–µ–Ω—ã
- ‚úÖ Deep link –≤ Mini App

**–ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:**
- ‚ùå –ù–µ—Ç –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
- ‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö
- ‚ö†Ô∏è –°–ª–æ–∂–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

#### Audio-first flow (NEW inline keyboard) ‚úÖ

**–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π - –æ—Ç–ø—Ä–∞–≤–∏–ª –∞—É–¥–∏–æ, –≤—ã–±—Ä–∞–ª –¥–µ–π—Å—Ç–≤–∏–µ
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–µ emoji –∫–Ω–æ–ø–∫–∏
- ‚úÖ 5 –æ–ø—Ü–∏–π (Cover, Extend, Upload, Recognize, MIDI)

**–ß—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:**
- ‚ùå **–ö–†–ò–¢–ò–ß–ù–û:** –¢—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
- ‚ùå –ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (style, model) –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞—É–¥–∏–æ
- ‚ö†Ô∏è "Coming soon" —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ —Å–∫—Ä—ã—Ç—ã

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–ª–æ—É:**

```
User sends audio (150 sec)
‚Üì
Bot analyzes:
‚îú‚îÄ‚ñ∂ Duration: 2 –º–∏–Ω 30 —Å–µ–∫
‚îú‚îÄ‚ñ∂ Format: MP3
‚îú‚îÄ‚ñ∂ Size: 3.5 MB
‚îî‚îÄ‚ñ∂ Suitable models: V5, V4_5PLUS, V4 (NOT V4_5ALL)
‚Üì
Bot shows:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üéµ –ê—É–¥–∏–æ –ø–æ–ª—É—á–µ–Ω–æ!              ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ üìä –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 2:30           ‚îÇ
‚îÇ üì¶ –†–∞–∑–º–µ—Ä: 3.5 MB               ‚îÇ
‚îÇ ‚úÖ –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –º–æ–¥–µ–ª–∏: V5, V4+   ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ –ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?             ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ [üé§ –ö–∞–≤–µ—Ä] [‚ûï –†–∞—Å—à–∏—Ä–∏—Ç—å]        ‚îÇ
‚îÇ [üì§ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å] [‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

If user clicks [‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å]:
‚Üì
Bot shows setup dialog:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏          ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ –ú–æ–¥–µ–ª—å: [V5 ‚ñº]                  ‚îÇ
‚îÇ –°—Ç–∏–ª—å: [indie rock_____]        ‚îÇ
‚îÇ –†–µ–∂–∏–º: [‚óã –í–æ–∫–∞–ª ‚óè –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª] ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ [‚óÄÔ∏è –ù–∞–∑–∞–¥] [‚úÖ –°–æ–∑–¥–∞—Ç—å –∫–∞–≤–µ—Ä]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Then process IMMEDIATELY with stored file_id ‚úÖ
```

---

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑

### Edge Functions

#### suno-upload-cover/index.ts

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** ‚úÖ –•–æ—Ä–æ—à–∞—è
**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:** ‚úÖ JWT + Bot secret
**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- ‚úÖ customMode logic
- ‚úÖ style required if customMode
- ‚úÖ prompt required if !customMode
- ‚ùå **NO duration validation**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –∞—É–¥–∏–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)
2. –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å –∫–æ–¥–∞–º–∏
3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—É–¥–∏–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

#### suno-upload-extend/index.ts

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ suno-upload-cover**, –ø–ª—é—Å:
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä `continueAt`
- ‚úÖ Sanitization filename (–¥–ª—è Cyrillic)
- ‚ùå **NO duration validation**

### SunoAPI Integration

**Endpoint:** `https://api.sunoapi.org/api/v1/generate/upload-cover`

**Request body:**
```typescript
{
  uploadUrl: string,        // ‚úÖ
  customMode: boolean,      // ‚úÖ Fixed
  instrumental: boolean,    // ‚úÖ
  model: string,           // ‚úÖ Mapped correctly
  callBackUrl: string,     // ‚úÖ
  
  // If customMode:
  style: string,           // ‚úÖ Required
  prompt?: string,         // ‚úÖ Optional (lyrics)
  title?: string,          // ‚úÖ
  
  // Advanced:
  personaId?: string,      // ‚úÖ
  negativeTags?: string,   // ‚úÖ
  vocalGender?: 'm'|'f',   // ‚úÖ
  styleWeight?: number,    // ‚úÖ
  weirdnessConstraint?: number, // ‚úÖ
  audioWeight?: number     // ‚úÖ
}
```

**–ß—Ç–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è:**
- ‚ùå Duration validation BEFORE API call
- ‚ö†Ô∏è Retry logic on 430 (rate limit)
- ‚ö†Ô∏è Timeout handling for long requests

### Database Schema

**generation_tasks:**
```sql
- id, user_id, suno_task_id
- generation_mode: 'upload_cover' | 'upload_extend' ‚úÖ
- model_used: string ‚úÖ
- source: 'mini_app' | 'telegram' ‚úÖ
- telegram_chat_id: bigint? ‚úÖ
- status: 'pending' | 'completed' | 'failed' ‚úÖ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `audio_duration_seconds: integer?` –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `validation_errors: jsonb?` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**tracks:**
```sql
- generation_mode: 'upload_cover' | 'upload_extend' ‚úÖ
- suno_model: string ‚úÖ
- style, lyrics, has_vocals ‚úÖ
- negative_tags, vocal_gender, style_weight ‚úÖ
```

**–û—Ç–ª–∏—á–Ω–æ!** –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.

---

## üìã –ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π

| –ú–æ–¥–µ–ª—å | API Name | Web App | Bot | Duration Check Client | Duration Check Server | Callback Support |
|--------|----------|---------|-----|----------------------|----------------------|------------------|
| V5 | chirp-crow | ‚úÖ | ‚ùå | ‚ö†Ô∏è General only | ‚ùå | ‚úÖ |
| V4_5PLUS | chirp-bluejay | ‚úÖ | ‚ùå | ‚ö†Ô∏è General only | ‚ùå | ‚úÖ |
| V4_5ALL | chirp-auk | ‚úÖ (default) | ‚úÖ (default) | ‚úÖ 60s | ‚ùå | ‚úÖ |
| V4 | chirp-v4 | ‚úÖ | ‚ùå | ‚ùå **MISSING** | ‚ùå | ‚úÖ |

**–õ–µ–≥–µ–Ω–¥–∞:**
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
- ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
- ‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è

---

## üö® –°–ø–∏—Å–æ–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (CRITICAL)

1. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è V4 –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ**
   - **–§–∞–π–ª:** `src/components/UploadAudioDialog.tsx:191`
   - **–ü—Ä–æ–±–ª–µ–º–∞:** V4 –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å 240 —Å–µ–∫, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 480
   - **–†–∏—Å–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç 5-–º–∏–Ω—É—Ç–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è V4 ‚Üí –æ—à–∏–±–∫–∞ –≤ SunoAPI
   
2. **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   - **–§–∞–π–ª—ã:** `supabase/functions/suno-upload-cover/index.ts`, `suno-upload-extend/index.ts`
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é
   - **–†–∏—Å–∫:** –ü–æ—Ç–µ—Ä—è –∫—Ä–µ–¥–∏—Ç–æ–≤, –ø–ª–æ—Ö–æ–π UX

3. **Bot —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ**
   - **–§–∞–π–ª:** `supabase/functions/telegram-bot/commands/audio-upload.ts:handleAudioActionCallback`
   - **–ü—Ä–æ–±–ª–µ–º–∞:** Stored file_id –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
   - **–†–∏—Å–∫:** –ü–ª–æ—Ö–æ–π UX, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—É—Ç–∞—é—Ç—Å—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (HIGH)

4. **–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö –º–æ–¥–µ–ª–µ–π –≤ UI**
   - **–§–∞–π–ª:** `src/components/UploadAudioDialog.tsx`
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ª–∏–º–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
   - **–†–∏—Å–∫:** –ü–ª–æ—Ö–æ–π UX, –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫

5. **–ù–µ—Ç –∞–≤—Ç–æ–≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
   - **–§–∞–π–ª:** `src/components/UploadAudioDialog.tsx`
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤—Ä—É—á–Ω—É—é –≤—ã–±–∏—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â—É—é –º–æ–¥–µ–ª—å
   - **–†–∏—Å–∫:** –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏, —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ

6. **Bot –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏**
   - **–§–∞–π–ª:** `supabase/functions/telegram-bot/handlers/audio.ts`
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è V4_5ALL (60 —Å–µ–∫ –ª–∏–º–∏—Ç)
   - **–†–∏—Å–∫:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–∞–≤–µ—Ä –¥–ª—è —Ñ–∞–π–ª–æ–≤ > 60 —Å–µ–∫ —á–µ—Ä–µ–∑ bot

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (MEDIUM)

7. **–§—É–Ω–∫—Ü–∏—è getMaxDuration() –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è preview**
8. **–ù–µ—Ç –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤**
9. **"Coming soon" —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ bot inline keyboard**

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (CLIENT)

**–§–∞–π–ª:** `src/components/UploadAudioDialog.tsx`

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ª–∏–º–∏—Ç–æ–≤
const MODEL_DURATION_LIMITS: Record<string, number> = {
  'V5': 480,
  'V4_5PLUS': 480,
  'V4_5ALL': 60,
  'V4': 240,
  'V3_5': 180,
  'V3': 180,
};

// –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
const getModelDurationLimit = (modelKey: string): number => {
  return MODEL_DURATION_LIMITS[modelKey] || 480;
};

// –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–¥–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
const suggestModelForDuration = (durationSeconds: number): SunoModelKey => {
  if (durationSeconds <= 60) return 'V4_5ALL';
  if (durationSeconds <= 240) return 'V4';
  if (durationSeconds <= 480) return 'V5';
  // If > 480, return best model anyway
  return 'V5';
};

// –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ handleSubmit()
const handleSubmit = async () => {
  // ... existing validation ...
  
  // –ù–û–í–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  const maxDuration = getModelDurationLimit(model);
  if (audioDuration && audioDuration > maxDuration) {
    const modelName = SUNO_MODELS[model as keyof typeof SUNO_MODELS]?.name || model;
    const minutes = Math.floor(maxDuration / 60);
    const seconds = maxDuration % 60;
    const timeStr = seconds > 0 
      ? `${minutes} –º–∏–Ω ${seconds} —Å–µ–∫` 
      : `${minutes} –º–∏–Ω`;
    
    // Show error with suggestion
    const suggestedModel = suggestModelForDuration(audioDuration);
    const suggestedName = SUNO_MODELS[suggestedModel]?.name;
    
    toast.error(`–í–∞—à–µ –∞—É–¥–∏–æ (${Math.floor(audioDuration / 60)}:${String(Math.floor(audioDuration % 60)).padStart(2, '0')}) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –º–æ–¥–µ–ª–∏ ${modelName} (${timeStr})`, {
      description: suggestedModel !== model 
        ? `–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –º–æ–¥–µ–ª—å ${suggestedName}` 
        : undefined,
      action: suggestedModel !== model ? {
        label: `–í—ã–±—Ä–∞—Ç—å ${suggestedName}`,
        onClick: () => setModel(suggestedModel),
      } : undefined,
    });
    return;
  }
  
  // ... rest of submit logic ...
};
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (SERVER)

**–§–∞–π–ª:** `supabase/functions/suno-upload-cover/index.ts` –∏ `suno-upload-extend/index.ts`

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è publicUrl

// Model duration limits (in seconds)
const MODEL_DURATION_LIMITS: Record<string, number> = {
  'V5': 480,
  'V4_5PLUS': 480,
  'V4_5': 60,  // V4_5ALL maps to V4_5
  'V4': 240,
  'V3_5': 180,
};

// Get duration from audio file
// Note: This requires downloading and parsing audio metadata
// For now, we can add a duration parameter from client
const { audioDuration } = body; // Add to request body

if (audioDuration) {
  const maxDuration = MODEL_DURATION_LIMITS[apiModel] || 480;
  
  if (audioDuration > maxDuration) {
    logger.warn('Audio duration exceeds model limit', {
      duration: audioDuration,
      model: apiModel,
      limit: maxDuration
    });
    
    return new Response(
      JSON.stringify({
        error: `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—É–¥–∏–æ (${Math.floor(audioDuration)}—Å) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –º–æ–¥–µ–ª–∏ ${apiModel} (${maxDuration}—Å)`,
        errorCode: 'DURATION_LIMIT_EXCEEDED',
        duration: audioDuration,
        limit: maxDuration,
        suggestedModel: audioDuration <= 240 ? 'V4' : 'V5',
      }),
      { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
}
```

**–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ client request:**
```typescript
// –í UploadAudioDialog.tsx
const body: Record<string, unknown> = {
  audioFile: { name, type, data },
  audioDuration: audioDuration, // ADD THIS
  model,
  // ... rest
};
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 3: Auto-process audio –≤ Bot

**–§–∞–π–ª:** `supabase/functions/telegram-bot/commands/audio-upload.ts`

```typescript
export async function handleAudioActionCallback(
  chatId: number,
  userId: number,
  action: string,
  messageId: number,
  callbackId: string
): Promise<void> {
  const { answerCallbackQuery, editMessageText } = await import('../telegram-api.ts');
  const { consumePendingAudio } = await import('../core/db-session-store.ts');
  
  // Get the stored audio file_id
  const audioData = await consumePendingAudio(userId);
  
  if (!audioData) {
    await answerCallbackQuery(callbackId, '‚ö†Ô∏è –ê—É–¥–∏–æ —Ñ–∞–π–ª –∏—Å—Ç—ë–∫. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–Ω–æ–≤–∞.');
    return;
  }
  
  // Get user profile
  const { data: profile } = await supabase
    .from('profiles')
    .select('user_id')
    .eq('telegram_id', userId)
    .single();
  
  if (!profile) {
    await answerCallbackQuery(callbackId, '‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }
  
  try {
    // Download file from Telegram
    const fileUrl = await getFileUrl(audioData.fileId);
    if (!fileUrl) {
      await answerCallbackQuery(callbackId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ–∞–π–ª');
      return;
    }
    
    // Update message to show processing
    await editMessageText(chatId, messageId, `‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∞—É–¥–∏–æ\\.\\.\\.`);
    await answerCallbackQuery(callbackId, 'üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞...');
    
    // Download audio
    const audioResponse = await fetch(fileUrl);
    if (!audioResponse.ok) {
      throw new Error('Failed to download audio');
    }
    
    const audioBlob = await audioResponse.blob();
    const audioBuffer = await audioBlob.arrayBuffer();
    const base64Audio = btoa(String.fromCharCode(...new Uint8Array(audioBuffer)));
    
    // Prepare audio file object
    const audioFile = {
      name: `telegram_audio_${Date.now()}.mp3`,
      type: 'audio/mpeg',
      data: `data:audio/mpeg;base64,${base64Audio}`,
    };
    
    // Determine mode and call appropriate function
    let result;
    if (action === 'cover') {
      result = await processAudioCover(profile.user_id, audioFile, chatId);
    } else if (action === 'extend') {
      result = await processAudioExtend(profile.user_id, audioFile, chatId);
    } else if (action === 'upload') {
      // Handle upload to cloud
      result = await processAudioUploadToCloud(profile.user_id, audioFile, chatId);
    } else {
      await answerCallbackQuery(callbackId, '‚è≥ –§—É–Ω–∫—Ü–∏—è —Å–∫–æ—Ä–æ...');
      return;
    }
    
    if (result.success) {
      const modeText = action === 'cover' ? '–∫–∞–≤–µ—Ä–∞' : 
                       action === 'extend' ? '—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è' : '–∑–∞–≥—Ä—É–∑–∫–∏';
      
      await editMessageText(chatId, messageId, `‚úÖ *–ì–µ–Ω–µ—Ä–∞—Ü–∏—è ${modeText} –Ω–∞—á–∞–ª–∞—Å—å\\!*

‚è≥ –û–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç 2\\-4 –º–∏–Ω—É—Ç—ã
üîî –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ —Ç—Ä–µ–∫ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤

üÜî –ó–∞–¥–∞—á–∞: \`${escapeMarkdown(result.taskId || 'N/A')}\``, {
        inline_keyboard: [[
          { text: 'üì± –û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', web_app: { url: BOT_CONFIG.miniAppUrl } }
        ]]
      });
    } else {
      await editMessageText(chatId, messageId, `‚ùå *–û—à–∏–±–∫–∞*

${escapeMarkdown(result.error || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ')}`);
    }
    
  } catch (error) {
    logger.error('Error in handleAudioActionCallback', error);
    await editMessageText(chatId, messageId, `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ\\.`);
  }
}

// Helper functions
async function processAudioCover(userId: string, audioFile: any, chatId: number) {
  // Call suno-upload-cover with bot authentication
  // ... implementation
}

async function processAudioExtend(userId: string, audioFile: any, chatId: number) {
  // Call suno-upload-extend with bot authentication
  // ... implementation
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 4: UI —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –ª–∏–º–∏—Ç–æ–≤ –º–æ–¥–µ–ª–µ–π

**–§–∞–π–ª:** `src/components/UploadAudioDialog.tsx`

```tsx
{/* Model selector with limits */}
<div className="space-y-2">
  <Label>–ú–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</Label>
  <Select value={model} onValueChange={setModel}>
    <SelectTrigger>
      <SelectValue />
    </SelectTrigger>
    <SelectContent>
      {getAvailableModels().map(m => {
        const limit = getModelDurationLimit(m.key);
        const isCompatible = !audioDuration || audioDuration <= limit;
        const minutes = Math.floor(limit / 60);
        
        return (
          <SelectItem 
            key={m.key} 
            value={m.key}
            disabled={!isCompatible}
          >
            <div className="flex items-center gap-2 w-full">
              <span>{m.emoji} {m.name}</span>
              <Badge 
                variant={isCompatible ? "default" : "destructive"}
                className="ml-auto"
              >
                –º–∞–∫—Å. {minutes} –º–∏–Ω
              </Badge>
            </div>
            <div className="text-xs text-muted-foreground mt-1">
              {m.desc}
            </div>
          </SelectItem>
        );
      })}
    </SelectContent>
  </Select>
  
  {/* Duration info */}
  {audioDuration && (
    <div className="text-sm text-muted-foreground">
      –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∞—à–µ–≥–æ –∞—É–¥–∏–æ: {Math.floor(audioDuration / 60)}:{String(Math.floor(audioDuration % 60)).padStart(2, '0')}
    </div>
  )}
  
  {/* Warning if exceeds */}
  {audioDuration && audioDuration > getModelDurationLimit(model) && (
    <Alert variant="destructive">
      <AlertCircle className="h-4 w-4" />
      <AlertTitle>–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –º–æ–¥–µ–ª–∏</AlertTitle>
      <AlertDescription className="space-y-2">
        <p>
          –í–∞—à–µ –∞—É–¥–∏–æ ({Math.floor(audioDuration / 60)} –º–∏–Ω {Math.floor(audioDuration % 60)} —Å–µ–∫) 
          –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç –º–æ–¥–µ–ª–∏ {SUNO_MODELS[model]?.name} 
          ({Math.floor(getModelDurationLimit(model) / 60)} –º–∏–Ω).
        </p>
        <Button 
          variant="outline" 
          size="sm"
          onClick={() => {
            const suggested = suggestModelForDuration(audioDuration);
            setModel(suggested);
            toast.success(`–í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å ${SUNO_MODELS[suggested]?.name}`);
          }}
        >
          –í—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â—É—é –º–æ–¥–µ–ª—å
        </Button>
      </AlertDescription>
    </Alert>
  )}
</div>
```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: 7/10

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ (85%):**
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã API —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–¥–µ–∂–Ω–∞—è
- ‚úÖ UI –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π
- ‚úÖ Database schema –ø–æ–ª–Ω–∞—è
- ‚úÖ Callback system —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (15%):**
- ‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ–ø–æ–ª–Ω–∞—è (–ö–†–ò–¢–ò–ß–ù–û)
- ‚ùå Bot —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (UX –ø—Ä–æ–±–ª–µ–º–∞)
- ‚ö†Ô∏è –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö –≤ UI
- ‚ö†Ô∏è –ù–µ—Ç –∞–≤—Ç–æ–≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π: 9.5/10

**–ë—É–¥–µ—Ç:**
- ‚úÖ –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ client –∏ server
- ‚úÖ Auto-process –≤ bot (–±–µ–∑ resend)
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π UI —Å –ª–∏–º–∏—Ç–∞–º–∏
- ‚úÖ –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä –º–æ–¥–µ–ª–∏
- ‚úÖ –õ—É—á—à–∏–π UX

---

## üéØ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –¥–Ω—è)

1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é V4 –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Å audioDuration –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º)
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å auto-process –≤ bot
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–º–∏—Ç–∞—Ö –≤ UI

### –§–∞–∑–∞ 2: UX —É–ª—É—á—à–µ–Ω–∏—è (2-3 –¥–Ω—è)

5. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
6. –£–ª—É—á—à–∏—Ç—å model selector —Å badges
7. –î–æ–±–∞–≤–∏—Ç—å warning alerts
8. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –§–∞–∑–∞ 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

9. –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –≤ bot
10. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Recognize –∏ MIDI (coming soon)
11. –î–æ–±–∞–≤–∏—Ç—å progress bar –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
12. Waveform visualization

---

## üìù Checklist –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Web App - Cover

- [ ] Upload audio < 60s ‚Üí V4_5ALL ‚Üí Success
- [ ] Upload audio 61s-240s ‚Üí V4_5ALL ‚Üí Error with suggestion
- [ ] Upload audio 61s-240s ‚Üí V4 ‚Üí Success
- [ ] Upload audio 241s-480s ‚Üí V4 ‚Üí Error with suggestion
- [ ] Upload audio 241s-480s ‚Üí V5 ‚Üí Success
- [ ] Upload audio > 480s ‚Üí Any model ‚Üí Error
- [ ] Custom mode with style ‚Üí Success
- [ ] Simple mode with prompt ‚Üí Success
- [ ] Instrumental mode ‚Üí Success

### Web App - Extend

- [ ] Same as Cover scenarios
- [ ] ContinueAt parameter ‚Üí Success
- [ ] customMode parameter ‚Üí Success (not defaultParamFlag)

### Telegram Bot - Command first

- [ ] /cover ‚Üí Upload < 60s ‚Üí Success
- [ ] /cover ‚Üí Upload > 60s ‚Üí Error (–Ω–µ—Ç –¥—Ä—É–≥–æ–π –º–æ–¥–µ–ª–∏)
- [ ] /extend ‚Üí Upload < 60s ‚Üí Success
- [ ] /cover --style="rock" ‚Üí Success
- [ ] /cover --instrumental ‚Üí Success

### Telegram Bot - Audio first

- [ ] Upload audio ‚Üí Show inline keyboard ‚Üí Success
- [ ] Click Cover ‚Üí ~~Resend~~ Auto-process ‚Üí Success
- [ ] Click Extend ‚Üí ~~Resend~~ Auto-process ‚Üí Success
- [ ] Click Upload ‚Üí Save to cloud ‚Üí Success
- [ ] 5 min TTL ‚Üí Audio expires ‚Üí Show error

---

## üèÅ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–≤–µ—Ä–æ–≤ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤ **–≤ —Ü–µ–ª–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ**, –Ω–æ –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º**, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:

1. **–ù–µ–ø–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
2. **Bot —Ç—Ä–µ–±—É–µ—Ç resend** - –ø–ª–æ—Ö–æ–π UX
3. **–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏–º–∏—Ç–∞—Ö** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–Ω–∞—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞—Ä–∞–Ω–µ–µ

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç **production-ready** —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º 9.5/10.

---

**–ê—É–¥–∏—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω:** 2025-12-12  
**–ê–≤—Ç–æ—Ä:** Copilot AI Agent  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** üî¥ –í–´–°–û–ö–ò–ô

