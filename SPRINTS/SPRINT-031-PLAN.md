# Implementation Plan: Sprint 031 - Optimization Phase 2

**Branch**: `main` | **Date**: 2026-01-07 | **Spec**: [SPRINT-031-OPTIMIZATION-PHASE2.md](./SPRINT-031-OPTIMIZATION-PHASE2.md)
**Input**: Sprint specification from `/SPRINTS/SPRINT-031-OPTIMIZATION-PHASE2.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Sprint 031 focuses on **performance optimization and component integration** for the MusicVerse AI Telegram Mini App. The sprint continues optimization work from Sprint 030, with primary goals:

1. **Store Unification** - Consolidate client state in Zustand stores while maintaining TanStack Query for server state
2. **Component Optimizations** - Create React.memo versions of high-frequency render components (lyrics, playlists, mixer)
3. **DAW Timeline Improvements** - Add BPM-aware snap-to-grid, draggable playhead, and haptic feedback
4. **Testing & Validation** - Achieve 60 FPS scroll on mid-range devices (Pixel 5, iPhone 12)
5. **Cleanup & Documentation** - Deprecate legacy components and document technical debt

**Technical Approach**: Hybrid state management (Zustand for ephemeral UI state, TanStack Query for server state), React.memo with custom comparison functions for component optimization, RAF throttling for frequent updates, and IndexedDB caching for waveforms/audio buffers.

## Technical Context

**Language/Version**: TypeScript 5.9, React 19.2
**Primary Dependencies**:
- **State**: Zustand 5.0, TanStack Query 5.90
- **UI**: Tailwind CSS 3.4, shadcn/ui, Radix UI, Framer Motion
- **Audio**: Tone.js 14.9, Wavesurfer.js 7.8
- **Virtualization**: react-virtuoso
- **Gestures**: @use-gesture/react
- **Build**: Vite 5.0

**Storage**:
- **Database**: Supabase (PostgreSQL)
- **Cache**: IndexedDB (waveforms, audio buffers)
- **Client**: localStorage (drafts, preferences)

**Testing**:
- **Unit**: Jest 30.2, @testing-library/react
- **E2E**: Playwright 1.57
- **Performance**: Chrome DevTools, Lighthouse CI
- **Accessibility**: axe-core

**Target Platform**: Telegram Mini App (iOS Safari 15+, Chrome Android 100+)
**Project Type**: Mobile-first web application (Telegram Mini App)
**Performance Goals**:
- 60 FPS scroll on lists with 1000+ items (mid-range devices)
- Mixer channel re-renders: 1 per volume change (from ~10)
- Waveform load time (cached): <50ms (from ~500ms)
- Bundle size (studio): <180KB (from ~200KB)
- Memory usage (10 stems): <100MB (from ~150MB)

**Constraints**:
- Bundle size HARD LIMIT: 950KB (enforced by size-limit)
- Touch targets: minimum 44×44px (iOS HIG)
- Safe areas: must respect notch/island (env(safe-area-inset-*))
- Audio: single HTMLAudioElement managed by GlobalAudioProvider

**Scale/Scope**:
- 946 TSX components in codebase
- 40+ pages with lazy loading
- 13 new optimized components created in Phase 1
- 8 Zustand stores for global state
- Target devices: Pixel 5, iPhone 12 (mid-range, 80%+ of users)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Mobile-First Development ✅ PASS

- [x] Portrait orientation primary
- [x] Touch targets 44-56px (OptimizedMixerChannel, OptimizedVolumeSlider)
- [x] Telegram SDK integration (haptic feedback in Phase 4)
- [x] Safe areas respected (existing MainLayout)
- [x] visualViewport API for keyboard (existing implementation)

### II. Performance & Bundle Optimization ✅ PASS

- [x] Bundle size < 950KB (target: <180KB for studio chunk)
- [x] Route-level code splitting (existing)
- [x] Framer Motion via @/lib/motion (existing pattern)
- [x] List virtualization (react-virtuoso for OptimizedLyricsPanel)
- [x] LazyImage component (existing)
- [x] Vendor chunks defined in vite.config.ts

### III. Audio Architecture ✅ PASS

- [x] Single audio element via GlobalAudioProvider (existing)
- [x] Audio element pooling for iOS (existing in audioElementPool)
- [x] playerStore for state (existing)
- [x] Audio caching via IndexedDB (useWaveformCache)

### IV. Component Architecture ✅ PASS

- [x] shadcn/ui patterns (OptimizedMixerChannel, OptimizedTransport)
- [x] Feature-based organization (src/components/studio/unified/)
- [x] cn() utility for className merging
- [x] @/ alias imports (no relative paths)
- [x] TypeScript strict mode (no any types)

### V. State Management Strategy ✅ PASS

- [x] Zustand for client state (useUnifiedStudioStore)
- [x] TanStack Query for server state (tracks, stems, playlists)
- [x] React Hook Form + Zod for forms (existing)
- [x] useState/useReducer for local UI state

**Clarification Applied**: Hybrid approach confirmed - Zustand handles ephemeral UI state (playback, mixer controls) while TanStack Query manages server state (tracks, stems, playlists) with caching and invalidation.

### VI. Security & Privacy ✅ PASS

- [x] RLS policies on all user data tables (existing)
- [x] Secrets in Edge Functions only (no frontend secrets)
- [x] Zod validation for input (existing)
- [x] DOMPurify for sanitization (existing)
- [x] Telegram initData validation (existing)

### VII. Accessibility & UX Standards ✅ PASS

- [x] Touch targets 44-56px (all optimized components)
- [x] ARIA labels for icon buttons (existing pattern)
- [x] Keyboard navigation (existing)
- [x] WCAG AA contrast (existing)
- [x] prefers-reduced-motion respected (Phase 4)
- [x] Haptic feedback via Telegram SDK (Phase 4)

### VIII. Unified Component Architecture ✅ PASS

- [x] MainLayout for root layout (existing)
- [x] BottomNavigation for mobile (existing)
- [x] MobileHeaderBar for page headers (existing)
- [x] MobileBottomSheet for modals (existing)
- [x] VirtualizedTrackList for lists (existing)
- [x] UnifiedStudioMobile for studio (existing)

### IX. Screen Development Patterns ✅ PASS

- [x] React.lazy() for route-level splitting (existing)
- [x] TanStack Query for data fetching (existing)
- [x] Zustand stores for global state (Phase 2)
- [x] Framer Motion via @/lib/motion (existing)
- [x] shadcn/ui for base components (existing)
- [x] React Hook Form + Zod for forms (existing)

### X. Performance Budget Enforcement ✅ PASS

- [x] Bundle size < 950KB (enforced by pre-commit hook)
- [x] Feature chunks: feature-studio <72KB (target: <180KB total)
- [x] Route-level code splitting (existing)
- [x] LazyImage for all images (existing)
- [x] List virtualization for >50 items (Phase 3)
- [x] GPU-accelerated animations (transform, opacity only)

**Constitution Check Result**: ✅ ALL GATES PASSED - No violations detected. Proceed to Phase 0.

## Project Structure

### Documentation (this sprint)

```text
SPRINTS/
├── SPRINT-031-OPTIMIZATION-PHASE2.md    # Sprint specification
├── SPRINT-031-PLAN.md                   # This file (/speckit.plan output)
├── SPRINT-031-RESEARCH.md               # Phase 0 output (research findings)
└── SPRINT-031-TASKS.md                  # Phase 2 output (/speckit.tasks - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── components/
│   ├── studio/
│   │   └── unified/
│   │       ├── OptimizedMixerChannel.tsx      # ✅ Created (Phase 1)
│   │       ├── OptimizedMixerPanel.tsx        # ✅ Created (Phase 1)
│   │       ├── OptimizedTransport.tsx         # ✅ Created (Phase 1)
│   │       ├── OptimizedTrackRow.tsx          # ✅ Created (Phase 1)
│   │       ├── OptimizedStemTrack.tsx         # ✅ Created (Phase 1)
│   │       ├── OptimizedWaveform.tsx          # ✅ Created (Phase 1)
│   │       ├── OptimizedVolumeSlider.tsx      # ✅ Created (Phase 1)
│   │       ├── OptimizedLyricsLine.tsx        # ⬜ Phase 3 (React.memo)
│   │       ├── OptimizedLyricsPanel.tsx       # ⬜ Phase 3 (virtualized)
│   │       ├── MobileDAWTimeline.tsx          # ⬜ Phase 4 (BPM, snap-to-grid)
│   │       └── StudioShell.tsx                # ⬜ Phase 2 (state migration)
│   ├── lyrics/
│   │   └── OptimizedLyricsLine.tsx            # ⬜ Phase 3 (new)
│   └── ui/
│       └── lazy-image.tsx                     # ✅ Existing (used everywhere)
├── stores/
│   ├── useUnifiedStudioStore.ts               # ⬜ Phase 2 (create)
│   ├── slices/
│   │   ├── playbackSlice.ts                   # ✅ Created
│   │   └── stemMixerSlice.ts                  # ✅ Created
│   ├── usePlaybackStore.ts                    # ✅ Created
│   └── useStemMixerStore.ts                   # ✅ Created
├── hooks/
│   ├── studio/
│   │   ├── useStudioState.ts                  # ✅ Created
│   │   ├── useWaveformCache.ts                # ✅ Created
│   │   ├── useOptimizedPlayback.ts            # ✅ Created
│   │   ├── useRenderOptimization.ts           # ✅ Created
│   │   ├── useStudioGestures.ts               # ✅ Created
│   │   ├── useStudioModals.ts                 # ✅ Created
│   │   ├── useAudioBufferCache.ts             # ✅ Created
│   │   ├── useAudioSync.ts                    # ✅ Created
│   │   ├── useTransportSync.ts               # ✅ Created
│   │   ├── useVirtualizedTracks.ts            # ✅ Created
│   │   └── useLyricsSync.ts                   # ⬜ Phase 3 (create)
│   └── useUnifiedStudio.ts                    # ⬜ Phase 2 (update)
├── lib/
│   ├── audio/
│   │   ├── lyricsParser.ts                    # ⬜ Phase 3 (create)
│   │   └── musicalStructure.ts                # ✅ Created
│   └── audioCache.ts                          # ✅ Existing (IndexedDB)
└── types/
    └── sections.ts                            # ✅ Created

tests/
├── unit/
│   └── hooks/
│       ├── studio/
│       │   ├── useStudioState.test.ts         # ✅ Created
│       │   ├── useStudioPerformance.test.ts   # ✅ Created
│       │   └── useSwipeNavigation.test.ts     # ✅ Created
│       └── useUnifiedStudio.test.ts           # ✅ Created
├── integration/
│   └── studio/
│       └── tab-switching.test.tsx             # ✅ Updated
└── e2e/
    └── studio/
        └── unified-studio.spec.ts             # ✅ Created
```

**Structure Decision**: Single web application (Telegram Mini App) with React + TypeScript. Optimized components follow existing patterns in `src/components/studio/unified/`. New hooks in `src/hooks/studio/` follow established conventions. State management uses hybrid approach (Zustand + TanStack Query) as clarified in spec.

## Complexity Tracking

> **No violations requiring justification** - All Constitution checks passed.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |

---

## Phase 0: Research & Technical Decisions

> **Prerequisites**: Constitution Check ✅ PASSED

### Research Tasks

Based on Technical Context and clarifications needed, the following research areas have been identified:

1. **Zustand Store Slicing Strategy** (Phase 2)
   - Research: Best practices for combining existing slices (playbackSlice, stemMixerSlice) into unified store
   - Decision needed: Selector pattern for minimizing re-renders
   - Alternatives: Single slice vs. multi-slice architecture

2. **React.memo Custom Comparison Functions** (Phase 3)
   - Research: Optimal comparison strategies for lyrics lines, playlist items
   - Decision needed: Shallow vs. deep comparison for complex objects
   - Alternatives: useMemo/useCallback vs. React.memo

3. **BPM Detection and Snap-to-Grid Algorithms** (Phase 4)
   - Research: Audio BPM detection libraries and beat-snap algorithms
   - Decision needed: Fallback strategy when BPM unknown
   - Alternatives: Web Audio API analyzer vs. external libraries

4. **IndexedDB Caching for Audio Buffers** (Phase 1-2)
   - Research: Cache invalidation strategies, expiry policies
   - Decision needed: 7-day expiry vs. LRU eviction
   - Alternatives: IndexedDB vs. Cache API vs. memory-only

5. **RAF Throttling Patterns for Frequent Updates** (Phase 4)
   - Research: Optimal RAF throttling for playhead drag, zoom
   - Decision needed: Throttle interval (16ms vs. 32ms vs. 60fps)
   - Alternatives: RAF vs. setTimeout vs. requestIdleCallback

### Research Agents Dispatch

Research agents will be dispatched for each unknown. Results will be consolidated in `SPRINT-031-RESEARCH.md`.

---

## Phase 1: Design Artifacts

> **Prerequisites**: `SPRINT-031-RESEARCH.md` complete with all decisions documented

### 1.1 Data Model

**Entities to be documented** (extracted from Phase 2-4 tasks):

1. **UnifiedStudioState** (Zustand store)
   - Fields: currentTime, duration, isPlaying, activeVersion, stems[], masterVolume, soloTrack
   - Actions: play(), pause(), seek(), setStemVolume()
   - Selectors: getEffectiveVolume(), getIsMuted(), getActiveStems()

2. **LyricsLine** (OptimizedLyricsLine component)
   - Fields: id, text, startTime, endTime, words[], isActive, currentWord
   - State: editing, playing, paused
   - Validation: text non-empty, startTime < endTime

3. **WaveformCacheEntry** (IndexedDB)
   - Fields: audioUrl, peaks[], duration, cachedAt, expiresAt
   - Index: audioUrl (unique)
   - TTL: 7 days

4. **StemState** (useUnifiedStudioStore)
   - Fields: id, name, url, volume, pan, isMuted, isSolo, waveform
   - Computed: effectiveVolume (accounts for solo/mute)

5. **TimelineMarker** (MobileDAWTimeline)
   - Fields: time, label, type (beat, bar, section), isVisible

**Output**: `SPRINTS/SPRINT-031-DATA-MODEL.md`

### 1.2 API Contracts

**No external API contracts** - This sprint focuses on client-side optimization. Internal hooks and store interfaces will be documented in `quickstart.md`.

**Output**: `SPRINTS/SPRINT-031-QUICKSTART.md`

### 1.3 Agent Context Update

After Phase 1 design is complete, run:
```bash
.specify/scripts/powershell/update-agent-context.ps1 -AgentType claude
```

This will update `.claude/agents/spec-driven-developer.md` with new technologies and patterns from Sprint 031.

---

## Phase 2: Task Generation

> **Prerequisites**: Phase 1 artifacts complete (data-model.md, quickstart.md, agent context updated)

**NOT CREATED BY /speckit.plan** - Run `/speckit.tasks` command to generate `SPRINTS/SPRINT-031-TASKS.md` with actionable, dependency-ordered tasks for each phase.

---

## Success Metrics

### Performance Benchmarks (Target: Mid-range Devices)

| Metric | Before | Target | Measurement Method |
|--------|--------|--------|---------------------|
| TrackList scroll FPS | ~30 | 60 | Chrome DevTools Performance monitor |
| Mixer re-renders/volume change | ~10 | 1 | React DevTools Profiler |
| Waveform load (cached) | ~500ms | <50ms | Performance.mark() + measure() |
| Bundle size (studio) | ~200KB | <180KB | npm run size |
| Memory (10 stems) | ~150MB | <100MB | Chrome DevTools Memory profiler |

### Quality Metrics

- [ ] Test coverage ≥80% for new optimization hooks (useStudioState, useWaveformCache, useOptimizedPlayback)
- [ ] All P1 TODO items resolved or documented as technical debt
- [ ] Documentation updated (PERFORMANCE_OPTIMIZATION.md, KNOWLEDGE_BASE.md, PROJECT_STATUS.md)
- [ ] Legacy components deprecated with warnings (MobileStudioLayout, MobileStudioTabs)
- [ ] No regression in existing functionality (E2E tests pass)

---

## Risks & Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Store migration breaks existing studio functionality | HIGH | MEDIUM | Comprehensive E2E tests, gradual migration with feature flags |
| React.memo over-optimization causes bugs | MEDIUM | LOW | Thorough testing of optimized components, monitor for stale props |
| IndexedDB quota exceeded on mobile | MEDIUM | LOW | Implement LRU eviction, monitor cache size, fallback to memory |
| RAF throttling causes perceived lag | LOW | LOW | Test on target devices (Pixel 5, iPhone 12), adjust throttle interval |
| Bundle size exceeds limit | HIGH | LOW | Regular `npm run size` checks, code splitting, vendor chunk analysis |

---

## Dependencies

### External Dependencies

- **@use-gesture/react** - For touch gesture support (Phase 4)
- **react-virtuoso** - For list virtualization (existing)
- **IndexedDB** - For waveform/audio buffer caching (existing)

### Internal Dependencies

- **Phase 2 (Store Unification)** must complete before Phase 3 (Component Optimizations) can use unified selectors
- **Phase 3 (Component Optimizations)** should complete before Phase 4 (Timeline Improvements) to ensure consistent patterns
- **Phase 5 (Testing)** runs in parallel with Phase 2-4, with final validation after all phases complete

### Blocked By

- None - All dependencies resolved in clarifications

---

## Timeline Estimate

| Phase | Tasks | Estimate | Dependencies |
|-------|-------|----------|--------------|
| Phase 0 | Research & technical decisions | 4h | None |
| Phase 1 | Design artifacts generation | 2h | Phase 0 |
| Phase 2 | Store Unification | 5.5h | Phase 1 |
| Phase 3 | Component Optimizations | 6h | Phase 2 |
| Phase 4 | DAW Timeline Improvements | 6.5h | Phase 3 |
| Phase 5 | Testing & Validation | 8h | Phase 2-4 (parallel) |
| Phase 6 | Cleanup & Documentation | 2.75h | Phase 2-5 |
| **Total** | **11 tasks** | **34.75h (~1 week)** | - |

**Note**: Estimates assume mid-range devices (Pixel 5, iPhone 12) as performance targets. Actual time may vary based on complexity of store migration and testing requirements.

---

## Next Steps

1. ✅ Constitution Check complete - all gates passed
2. ⬜ Execute Phase 0: Research & Technical Decisions → `SPRINT-031-RESEARCH.md`
3. ⬜ Execute Phase 1: Design Artifacts → `SPRINT-031-DATA-MODEL.md`, `SPRINT-031-QUICKSTART.md`
4. ⬜ Update agent context: `.specify/scripts/powershell/update-agent-context.ps1 -AgentType claude`
5. ⬜ Execute `/speckit.tasks` to generate `SPRINT-031-TASKS.md`
6. ⬜ Begin implementation with Phase 2 (Store Unification)

---

**Plan Version**: 1.0.0
**Generated**: 2026-01-07
**Status**: Ready for Phase 0 Research
